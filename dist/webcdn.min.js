function Download(peerid,hash,contentHash,peernet,logger,callback){this.peerid=peerid,this.hash=hash,this.contentHash=contentHash,this.peernet=peernet,this.logger=logger,this.done=callback,this.chunks=[]}function Logger(options){this.DEBUG=options.debug}function Messenger(options){EventEmitter.call(this),this.socket=null,this.logger=options.logger}function Peer(options){EventEmitter.call(this),this.connection=null,this.dataChannel=null,this.callbacks={},this._id=options.id,this._wrtc=options.wrtc,this._iceUrls=options.iceUrls,this._originator=options.originator||!1,this._signalChannel=options.signalChannel,this._logger=options.logger,this._peernet=options.peernet,this.init()}function Peernet(options){if(!options||!options.signalChannel)throw new Error('Please specify a signalChannel {"signalChannel": signalChannel}');var self=this;EventEmitter.call(this),this.downloaded={},this.pending={},this._peers={},this._options=options,this._wrtc=options.wrtc===!1?void 0:getBrowserRTC()||options.wrtc,this._iceUrls=options.iceUrls||[{url:"stun:stun.l.google.com:19302"},{url:"stun:stun1.l.google.com:19302"},{url:"stun:stun2.l.google.com:19302"},{url:"stun:stun3.l.google.com:19302"},{url:"stun:stun4.l.google.com:19302"}],this._signalChannel=options.signalChannel,this._signalChannel.on("relay",function(data){self._handleRelayMessage.call(self,data)}),this._logger=options.logger}function Resource(hash,wsConnectDuration){if("undefined"==typeof hash)throw new Error("Hash ID as first parameter required!");if("undefined"==typeof wsConnectDuration)throw new Error("Websocket connect duration as second parameter required!");this.hash=hash,this.leecher=window.webcdn_uuid,this.ws_connect=wsConnectDuration}function createWebsocket(){var ws=new WebSocket(url);return ws.onmessage=function(event){JSON.parse(event.data)},ws.onopen=function(event){},ws}function Tracker(options){this._messenger=options.messenger}var Statistics=require("./statistics.js"),sha1=require("sha1");module.exports=Download,Download.prototype.start=function(){var self=this;if(this.peerid){Statistics.mark("fetch_start:"+self.hash);this.peernet.fetch(this.peerid,this.hash,function(arraybuffer){Statistics.mark("fetch_end:"+self.hash),Statistics.measureByType("fetch",self.hash,self.peerid),self.finish(arraybuffer)})}else Statistics.mark("cdn_fallback_start:"+this.hash),self._loadImageByCDN(self.hash)},Download.prototype.finish=function(arraybuffer){this.peernet.finishDownload(this.hash,arraybuffer,this.done)},Download.prototype._loadImageByCDN=function(hash){var self=this,element=document.querySelector('[data-webcdn-hash="'+hash+'"]'),url=element.dataset.webcdnFallback;if(url){var req=new XMLHttpRequest;req.open("GET",url,!0),req.responseType="arraybuffer",req.onerror=function(err){element.setAttribute("crossOrigin","anonymous"),element.src=url,self.logger.handleError(err)},req.onload=function(err){if(200==this.status){var arraybuffer=this.response;element.dataset.hasOwnProperty("webcdnContentHash")||(element.dataset.webcdnContentHash=self._createContentHash(arraybuffer)),Statistics.mark("cdn_fallback_end:"+self.hash);Statistics.measureByType("cdn_fallback",self.hash);self.peernet.finishDownload(self.hash,arraybuffer,self.done)}else self.logger.trace("XHR returned "+this.status)},req.send()}else self.logger.trace("No WebCDN fallback URL available")},Download.prototype._createContentHash=function(content){return sha1(new Uint8Array(content))},module.exports=function(callback){function saveGeolocation(position){window.localStorage&&(window.localStorage.setItem("latitude",position.latitude),window.localStorage.setItem("longitude",position.longitude))}function getGeolocation(){if(window.localStorage&&window.localStorage.getItem("latitude")&&window.localStorage.getItem("longitude")){var position={latitude:window.localStorage.getItem("latitude"),longitude:window.localStorage.getItem("longitude")};return position}return!1}function geo_success(position){var latitude=position.coords.latitude,longitude=position.coords.longitude,position={latitude:latitude,longitude:longitude};saveGeolocation(position),callback(null,position)}function geo_error(err){callback(err,null)}var localGeolocation=getGeolocation();if(localGeolocation)callback(null,localGeolocation);else if(navigator.geolocation)navigator.geolocation.getCurrentPosition(geo_success,geo_error);else{var err=new Error("Sorry, no geo position available.");callback(err,null)}},module.exports=Logger,Logger.prototype.handleError=function(err){this.DEBUG&&console.log("error: "+err)},Logger.prototype.trace=function(message,data){this.DEBUG&&(data?console.log(message,data):console.log(message))};var EventEmitter=require("events").EventEmitter,inherits=require("util").inherits;module.exports=Messenger,inherits(Messenger,EventEmitter),Messenger.prototype.connect=function(coordinatorUrl,callback){var self=this;return self.socket?(self.logger.trace("Socket exist, init fail."),void callback()):(self.socket=new WebSocket(coordinatorUrl),self.socket.onclose=function(event){self.logger.trace("WebSocket.onclose",event)},self.socket.onerror=function(event){self.logger.trace("WebSocket.onerror",event)},self.socket.onmessage=function(event){var msg=JSON.parse(event.data);"relay"===msg.type&&msg.data&&self._handleRelayMessage(msg),"lookup-response"===msg.type&&msg.data&&self._handleLookupResponse(msg.data)},void(self.socket.onopen=function(event){callback()}))},Messenger.prototype.disconnect=function(){this.socket.close(),this.socket=null},Messenger.prototype.send=function(type,data,receiver){var msg={type:type,data:data};receiver&&(msg.to=receiver);var s_msg=JSON.stringify(msg);this.socket.send(s_msg)},Messenger.prototype._handleRelayMessage=function(data){this.emit("relay",data)},Messenger.prototype._handleLookupResponse=function(data){this.emit("lookup-response:"+data.hash,data)};var EventEmitter=require("events").EventEmitter,inherits=require("util").inherits,bufferConcat=require("array-buffer-concat"),Statistics=require("./statistics.js"),Utils=require("./utils.js");module.exports=Peer,inherits(Peer,EventEmitter),Peer.prototype.init=function(){this.connection=this._createPeerConnection(),this.dataChannel=this._createDataChannel(this.connection,this._id)},Peer.prototype.doOffer=function(){var self=this;self.connection.createOffer(function(sessionDescription){self._setLocalAndSendMessage.call(self,sessionDescription)},self._logger.handleError)},Peer.prototype.doAnswer=function(){var self=this;self.connection.createAnswer(function(sessionDescription){self._setLocalAndSendMessage.call(self,sessionDescription)},self._logger.handleError)},Peer.prototype.setIceCandidates=function(candidate){var iceCandidate=new this._wrtc.RTCIceCandidate({candidate:candidate});this.connection.addIceCandidate(iceCandidate)},Peer.prototype._createPeerConnection=function(){var self=this,pc=new this._wrtc.RTCPeerConnection({iceServers:this._iceUrls});return pc.onicecandidate=function(event){event.candidate&&self._originator===!0&&self._iceCallback.call(self,event)},pc.onnegotiationneeded=function(){self._originator===!0&&self.doOffer()},pc.ondatachannel=function(event){event.channel.onmessage=function(event){self._handleMessage.call(self,event)},Statistics.mark("pc_connect_end:"+self._id),Statistics.PC_CONNECT_DURATION=Statistics.measureByType("pc_connect",self._id)},pc},Peer.prototype._createDataChannel=function(pc,label){var self=this,dc=self.connection.createDataChannel(label);return dc.onmessage=function(event){self._handleMessage.call(self,event)},dc},Peer.prototype._handleMessage=function(event){var msg=Utils.unmarshal(event.data);"fetch"===msg.type&&msg.hash?this._sendImage(msg.hash):"\n"==msg.data?(this._updateUploadRatio(msg.hash,this._peernet.pending[msg.hash].byteLength),this.callbacks[msg.hash](this._peernet.pending[msg.hash])):"fetch-response"===msg.type&&(this._peernet.pending[msg.hash]?this._peernet.pending[msg.hash]=bufferConcat(this._peernet.pending[msg.hash],msg.data):this._peernet.pending[msg.hash]=msg.data)},Peer.prototype._setLocalAndSendMessage=function(sessionDescription){var self=this;self.connection.setLocalDescription(sessionDescription,function(){self._relay.call(self,sessionDescription)},self._logger.handleError)},Peer.prototype._iceCallback=function(event){var data={type:"candidate",label:event.candidate.sdpMLineIndex,id:event.candidate.sdpMid,candidate:event.candidate.candidate};this._relay.call(this,data)},Peer.prototype._sendImage=function(hash){var self=this,chunkSize=25600,dataSent=0;if(this._peernet.downloaded.hasOwnProperty(hash)){var data=this._peernet.downloaded[hash],downloadSize=data.byteLength,sendAllData=function(){for(;downloadSize>dataSent;){var slideEndIndex=dataSent+chunkSize;if(slideEndIndex>downloadSize&&(slideEndIndex=downloadSize),self.dataChannel.bufferedAmount>5*chunkSize)return self._logger.trace("bufferedAmount ist too high! Slow down..."),void setTimeout(sendAllData,250);var chunk=data.slice(dataSent,slideEndIndex),msg={type:"fetch-response",hash:hash,data:chunk};if(self.dataChannel.send(Utils.marshal(msg)),dataSent=slideEndIndex,dataSent+1>=downloadSize){self._logger.trace("All data chunks for "+hash+" have been sent to "+self._id);var msg={type:"fetch-response",hash:hash,data:"\n"};self.dataChannel.send(JSON.stringify(msg))}}};sendAllData()}},Peer.prototype._relay=function(data){console.log("send relay messge to "+this._id),this._signalChannel.send("relay",data,this._id)},Peer.prototype._updateUploadRatio=function(hash,bytes){this._signalChannel.send("upload_ratio",{from:window.webcdn_uuid,to:this._id,hash:hash,size:bytes})};var EventEmitter=require("events").EventEmitter,inherits=require("util").inherits,Peer=require("./peer.js"),getBrowserRTC=require("get-browser-rtc"),Statistics=require("./statistics.js");module.exports=Peernet,inherits(Peernet,EventEmitter),Peernet.prototype.fetch=function(peerid,hash,callback){var data={type:"fetch",hash:hash};this._send(peerid,data,callback)},Peernet.prototype._send=function(peerid,data,callback){var peer=this._createConnection(peerid,!0);peer.callbacks[data.hash]=callback;var dataChannel=peer.dataChannel;return data=JSON.stringify(data),"undefined"==typeof dataChannel||null===dataChannel||"closing"===dataChannel.readyState||"closed"===dataChannel.readyState?void this._reset(peerid):void("open"===dataChannel.readyState?dataChannel.send(data):"connecting"===dataChannel.readyState&&(dataChannel.hasOwnProperty("queued")?dataChannel.queued.push(data):dataChannel.queued=[data],dataChannel.onopen=function(event){for(var i=0;i<dataChannel.queued.length;i++)dataChannel.send(dataChannel.queued[i])}))},Peernet.prototype._createConnection=function(peerid,originator){return this._peers[peerid]||(Statistics.mark("pc_connect_start:"+peerid),this._peers[peerid]=new Peer({id:peerid,originator:originator,signalChannel:this._signalChannel,peernet:this,logger:this._logger,iceUrls:this._iceUrls,wrtc:this._wrtc})),this._peers[peerid]},Peernet.prototype._reset=function(peerid){if(this._peers.hasOwnProperty(peerid)){var peer=this._peers[peerid];peer.connection.close(),delete this._peers[peerid]}},Peernet.prototype._handleRelayMessage=function(msg){var self=this,peer=this._createConnection(msg.from,!1);msg&&msg.data&&msg.data.sdp?(peer._otherSDP=msg.data,peer.connection.setRemoteDescription(new self._wrtc.RTCSessionDescription(msg.data),function(){"offer"===msg.data.type&&peer.doAnswer()})):msg&&msg.data&&msg.data.candidate&&peer.setIceCandidates(msg.data.candidate)},Peernet.prototype.finishDownload=function(hash,content,callback){this.downloaded[hash]=content,delete this.pending[hash],callback(this.downloaded[hash])},module.exports=Resource,Resource.prototype.setProperty=function(type,value){this[type]=value};var url="ws://webcdn-mediator.herokuapp.com?id="+window.webcdn_uuid,ws=createWebsocket(),Resource=require("./resource.js"),Statistics={};Statistics.WS_CONNECT_DURATION=!1,Statistics.PC_CONNECT_DURATION=!1,Statistics.resources={},Statistics.addHost=function(){var data={uuid:window.webcdn_uuid,active:!0};Statistics.sendMessage("host:add",data)},Statistics.sendTimingData=function(){if(window.performance&&window.performance.timing){var data=window.performance.timing.toJSON();data.page_load=data.loadEventEnd-data.navigationStart,Statistics.sendMessage("plain:timing",data)}},Statistics.removeHost=function(){var data={uuid:window.webcdn_uuid};Statistics.sendMessage("host:remove",data)},Statistics.sendMessage=function(type,data){function waitForConnection(callback,interval){if(1===ws.readyState)callback();else{setTimeout(function(){waitForConnection(callback,interval)},interval)}}var message={type:type,data:data};waitForConnection(function(){ws.send(JSON.stringify(message))},500)},Statistics.queryResourceTiming=function(name){if("performance"in window&&"getEntriesByType"in window.performance&&window.performance.getEntriesByType("resource")instanceof Array){var timings=window.performance.getEntriesByName(name);if(timings&&timings[0]){var data={name:timings[0].name,initiatorType:timings[0].initiatorType,entryType:timings[0].entryType,fetchStart:timings[0].fetchStart,responseStart:timings[0].responseStart,responseEnd:timings[0].responseEnd,duration:timings[0].duration,startTime:timings[0].startTime,uuid:window.webcdn_uuid};Statistics.sendMessage("resource_timing",data)}}else;},Statistics.mark=function(name){window.performance&&window.performance.mark&&window.performance.mark(name)},Statistics.measureByType=function(type,hash,peerid){console.log("measure "+type+" with hash "+hash);var name=duration=type+"_duration",start=type+"_start",end=type+"_end";hash&&(name+=":"+hash,start+=":"+hash,end+=":"+hash),window.performance.measure(name,start,end);var result=window.performance.getEntriesByName(name);if(result&&result[0]){if("ws_connect"!==type&&"pc_connect"!==type&&hash){var resource=Statistics.resources[hash]=this._createResource(hash);if("lookup"===type&&resource.setProperty("ws_connect",Statistics.WS_CONNECT_DURATION),"fetch"===type&&resource.setProperty("seeder",peerid),resource.setProperty(type,result[0].duration),"cdn_fallback"===type||"fetch"===type){var data=JSON.stringify(resource);Statistics.sendMessage(duration,data)}}return result[0].duration}return!1},Statistics.measure=function(){window.performance.getEntriesByType("mark").forEach(function(mark){var arr=mark.name.split(":"),type=arr[0],id=arr[1];"lookup_start"===type&&window.performance.measure("lookup_duration:"+id,"lookup_start:"+id,"lookup_end:"+id),"pc_connect_start"===type&&window.performance.measure("pc_connect_duration:"+id,"pc_connect_start:"+id,"pc_connect_end:"+id),"fetch_start"===type&&window.performance.measure("fetch_duration:"+id,"fetch_start:"+id,"fetch_end:"+id)});var measures=window.performance.getEntriesByType("measure");measures.forEach(function(measure){var arr=measure.name.split(":"),type=arr[0],hash=arr[1],data={uuid:window.webcdn_uuid,hash:hash,duration:measure.duration};Statistics.sendMessage(type,data)})},Statistics._createResource=function(hash){return Statistics.resources&&Statistics.resources[hash]?Statistics.resources[hash]:new Resource(hash,Statistics.WS_CONNECT_DURATION)},window.WebCDNStatistics=Statistics,module.exports=Statistics;var Statistics=require("./statistics.js");module.exports=Tracker,Tracker.prototype.getInfo=function(hash,callback){this._messenger.send("lookup",hash),this._messenger.once("lookup-response:"+hash,function(data){callback(data)})};var Utils={};Utils.marshalBuffer=function(buffer){for(var str="",bytes=new Uint8Array(buffer),len=bytes.byteLength,i=0;len>i;i++)str+=String.fromCharCode(bytes[i]);return str},Utils.unmarshalBuffer=function(str){for(var len=str.length,bytes=new Uint8Array(len),i=0;len>i;i++)bytes[i]=str.charCodeAt(i);return bytes.buffer},Utils.marshal=function(message){return message.data instanceof ArrayBuffer&&(message.data=this.marshalBuffer(message.data)),JSON.stringify(message)},Utils.unmarshal=function(data){var message=JSON.parse(data);return message.hasOwnProperty("data")&&"\n"!==message.data&&(message.data=this.unmarshalBuffer(message.data)),message},module.exports=Utils;var UUID=function(){function b(a){return a?(a^16*Math.random()>>a/4).toString(16):([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,b)}return b}();module.exports=UUID,function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a="function"==typeof require&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error("Cannot find module '"+o+"'");throw f.code="MODULE_NOT_FOUND",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e)},l,l.exports,e,t,n,r)}return n[o].exports}for(var i="function"==typeof require&&require,o=0;o<r.length;o++)s(r[o]);return s}({1:[function(require,module,exports){function Resource(hash,wsConnectDuration){if("undefined"==typeof hash)throw new Error("Hash ID as first parameter required!");if("undefined"==typeof wsConnectDuration)throw new Error("Websocket connect duration as second parameter required!");this.hash=hash,this.leecher=window.webcdn_uuid,this.ws_connect=wsConnectDuration}module.exports=Resource,Resource.prototype.setProperty=function(type,value){this[type]=value}},{}],2:[function(require,module,exports){function createWebsocket(){var ws=new WebSocket(url);return ws.onmessage=function(event){JSON.parse(event.data)},ws.onopen=function(event){},ws}var url="ws://webcdn-mediator.herokuapp.com?id="+window.webcdn_uuid,ws=createWebsocket(),Resource=require("./resource.js"),Statistics={};Statistics.WS_CONNECT_DURATION=!1,Statistics.PC_CONNECT_DURATION=!1,Statistics.resources={},Statistics.addHost=function(){var data={uuid:window.webcdn_uuid,active:!0};Statistics.sendMessage("host:add",data)},Statistics.sendTimingData=function(){if(window.performance&&window.performance.timing){var data=window.performance.timing.toJSON();data.page_load=data.loadEventEnd-data.navigationStart,Statistics.sendMessage("plain:timing",data)}},Statistics.removeHost=function(){var data={uuid:window.webcdn_uuid};Statistics.sendMessage("host:remove",data)},Statistics.sendMessage=function(type,data){function waitForConnection(callback,interval){if(1===ws.readyState)callback();else{setTimeout(function(){waitForConnection(callback,interval)},interval)}}var message={type:type,data:data};waitForConnection(function(){ws.send(JSON.stringify(message))},500)},Statistics.queryResourceTiming=function(name){if("performance"in window&&"getEntriesByType"in window.performance&&window.performance.getEntriesByType("resource")instanceof Array){var timings=window.performance.getEntriesByName(name);if(timings&&timings[0]){var data={name:timings[0].name,initiatorType:timings[0].initiatorType,entryType:timings[0].entryType,fetchStart:timings[0].fetchStart,responseStart:timings[0].responseStart,responseEnd:timings[0].responseEnd,duration:timings[0].duration,startTime:timings[0].startTime,uuid:window.webcdn_uuid};Statistics.sendMessage("resource_timing",data)}}else;},Statistics.mark=function(name){window.performance&&window.performance.mark&&window.performance.mark(name)},Statistics.measureByType=function(type,hash,peerid){console.log("measure "+type+" with hash "+hash);var name=duration=type+"_duration",start=type+"_start",end=type+"_end";hash&&(name+=":"+hash,start+=":"+hash,end+=":"+hash),window.performance.measure(name,start,end);var result=window.performance.getEntriesByName(name);if(result&&result[0]){if("ws_connect"!==type&&"pc_connect"!==type&&hash){var resource=Statistics.resources[hash]=this._createResource(hash);if("lookup"===type&&resource.setProperty("ws_connect",Statistics.WS_CONNECT_DURATION),"fetch"===type&&resource.setProperty("seeder",peerid),resource.setProperty(type,result[0].duration),"cdn_fallback"===type||"fetch"===type){var data=JSON.stringify(resource);Statistics.sendMessage(duration,data)}}return result[0].duration}return!1},Statistics.measure=function(){window.performance.getEntriesByType("mark").forEach(function(mark){var arr=mark.name.split(":"),type=arr[0],id=arr[1];"lookup_start"===type&&window.performance.measure("lookup_duration:"+id,"lookup_start:"+id,"lookup_end:"+id),"pc_connect_start"===type&&window.performance.measure("pc_connect_duration:"+id,"pc_connect_start:"+id,"pc_connect_end:"+id),"fetch_start"===type&&window.performance.measure("fetch_duration:"+id,"fetch_start:"+id,"fetch_end:"+id)});var measures=window.performance.getEntriesByType("measure");measures.forEach(function(measure){var arr=measure.name.split(":"),type=arr[0],hash=arr[1],data={uuid:window.webcdn_uuid,hash:hash,duration:measure.duration};Statistics.sendMessage(type,data)})},Statistics._createResource=function(hash){return Statistics.resources&&Statistics.resources[hash]?Statistics.resources[hash]:new Resource(hash,Statistics.WS_CONNECT_DURATION)},window.WebCDNStatistics=Statistics,module.exports=Statistics},{"./resource.js":1}]},{},[2]),function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a="function"==typeof require&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error("Cannot find module '"+o+"'");throw f.code="MODULE_NOT_FOUND",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e)},l,l.exports,e,t,n,r)}return n[o].exports}for(var i="function"==typeof require&&require,o=0;o<r.length;o++)s(r[o]);return s}({1:[function(require,module,exports){function arrayBufferConcat(){var length=0,buffer=null;for(var i in arguments)buffer=arguments[i],length+=buffer.byteLength;var joined=new Uint8Array(length),offset=0;for(var i in arguments)buffer=arguments[i],joined.set(new Uint8Array(buffer),offset),offset+=buffer.byteLength;return joined.buffer}module.exports=arrayBufferConcat},{}],2:[function(require,module,exports){function Buffer(arg){return this instanceof Buffer?(this.length=0,this.parent=void 0,"number"==typeof arg?fromNumber(this,arg):"string"==typeof arg?fromString(this,arg,arguments.length>1?arguments[1]:"utf8"):fromObject(this,arg)):arguments.length>1?new Buffer(arg,arguments[1]):new Buffer(arg)}function fromNumber(that,length){if(that=allocate(that,0>length?0:0|checked(length)),!Buffer.TYPED_ARRAY_SUPPORT)for(var i=0;length>i;i++)that[i]=0;return that}function fromString(that,string,encoding){("string"!=typeof encoding||""===encoding)&&(encoding="utf8");var length=0|byteLength(string,encoding);return that=allocate(that,length),that.write(string,encoding),that}function fromObject(that,object){if(Buffer.isBuffer(object))return fromBuffer(that,object);if(isArray(object))return fromArray(that,object);if(null==object)throw new TypeError("must start with number, buffer, array or string");return"undefined"!=typeof ArrayBuffer&&object.buffer instanceof ArrayBuffer?fromTypedArray(that,object):object.length?fromArrayLike(that,object):fromJsonObject(that,object)}function fromBuffer(that,buffer){var length=0|checked(buffer.length);return that=allocate(that,length),buffer.copy(that,0,0,length),that}function fromArray(that,array){var length=0|checked(array.length);that=allocate(that,length);for(var i=0;length>i;i+=1)that[i]=255&array[i];return that}function fromTypedArray(that,array){var length=0|checked(array.length);that=allocate(that,length);for(var i=0;length>i;i+=1)that[i]=255&array[i];return that}function fromArrayLike(that,array){var length=0|checked(array.length);that=allocate(that,length);for(var i=0;length>i;i+=1)that[i]=255&array[i];return that}function fromJsonObject(that,object){var array,length=0;"Buffer"===object.type&&isArray(object.data)&&(array=object.data,length=0|checked(array.length)),that=allocate(that,length);for(var i=0;length>i;i+=1)that[i]=255&array[i];return that}function allocate(that,length){Buffer.TYPED_ARRAY_SUPPORT?that=Buffer._augment(new Uint8Array(length)):(that.length=length,that._isBuffer=!0);var fromPool=0!==length&&length<=Buffer.poolSize>>>1;return fromPool&&(that.parent=rootParent),that}function checked(length){if(length>=kMaxLength)throw new RangeError("Attempt to allocate Buffer larger than maximum size: 0x"+kMaxLength.toString(16)+" bytes");return 0|length}function SlowBuffer(subject,encoding){if(!(this instanceof SlowBuffer))return new SlowBuffer(subject,encoding);var buf=new Buffer(subject,encoding);return delete buf.parent,buf}function byteLength(string,encoding){if("string"!=typeof string&&(string=String(string)),0===string.length)return 0;switch(encoding||"utf8"){case"ascii":case"binary":case"raw":return string.length;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return 2*string.length;case"hex":return string.length>>>1;case"utf8":case"utf-8":return utf8ToBytes(string).length;case"base64":return base64ToBytes(string).length;default:return string.length}}function hexWrite(buf,string,offset,length){offset=Number(offset)||0;var remaining=buf.length-offset;length?(length=Number(length),length>remaining&&(length=remaining)):length=remaining;var strLen=string.length;if(strLen%2!==0)throw new Error("Invalid hex string");length>strLen/2&&(length=strLen/2);for(var i=0;length>i;i++){var parsed=parseInt(string.substr(2*i,2),16);if(isNaN(parsed))throw new Error("Invalid hex string");buf[offset+i]=parsed}return i}function utf8Write(buf,string,offset,length){return blitBuffer(utf8ToBytes(string,buf.length-offset),buf,offset,length)}function asciiWrite(buf,string,offset,length){return blitBuffer(asciiToBytes(string),buf,offset,length)}function binaryWrite(buf,string,offset,length){return asciiWrite(buf,string,offset,length)}function base64Write(buf,string,offset,length){return blitBuffer(base64ToBytes(string),buf,offset,length)}function ucs2Write(buf,string,offset,length){return blitBuffer(utf16leToBytes(string,buf.length-offset),buf,offset,length)}function base64Slice(buf,start,end){return 0===start&&end===buf.length?base64.fromByteArray(buf):base64.fromByteArray(buf.slice(start,end))}function utf8Slice(buf,start,end){var res="",tmp="";end=Math.min(buf.length,end);for(var i=start;end>i;i++)buf[i]<=127?(res+=decodeUtf8Char(tmp)+String.fromCharCode(buf[i]),tmp=""):tmp+="%"+buf[i].toString(16);return res+decodeUtf8Char(tmp)}function asciiSlice(buf,start,end){var ret="";end=Math.min(buf.length,end);for(var i=start;end>i;i++)ret+=String.fromCharCode(127&buf[i]);return ret}function binarySlice(buf,start,end){var ret="";end=Math.min(buf.length,end);for(var i=start;end>i;i++)ret+=String.fromCharCode(buf[i]);return ret}function hexSlice(buf,start,end){var len=buf.length;(!start||0>start)&&(start=0),(!end||0>end||end>len)&&(end=len);for(var out="",i=start;end>i;i++)out+=toHex(buf[i]);return out}function utf16leSlice(buf,start,end){for(var bytes=buf.slice(start,end),res="",i=0;i<bytes.length;i+=2)res+=String.fromCharCode(bytes[i]+256*bytes[i+1]);return res}function checkOffset(offset,ext,length){if(offset%1!==0||0>offset)throw new RangeError("offset is not uint");if(offset+ext>length)throw new RangeError("Trying to access beyond buffer length")}function checkInt(buf,value,offset,ext,max,min){if(!Buffer.isBuffer(buf))throw new TypeError("buffer must be a Buffer instance");if(value>max||min>value)throw new RangeError("value is out of bounds");if(offset+ext>buf.length)throw new RangeError("index out of range")}function objectWriteUInt16(buf,value,offset,littleEndian){0>value&&(value=65535+value+1);for(var i=0,j=Math.min(buf.length-offset,2);j>i;i++)buf[offset+i]=(value&255<<8*(littleEndian?i:1-i))>>>8*(littleEndian?i:1-i)}function objectWriteUInt32(buf,value,offset,littleEndian){0>value&&(value=4294967295+value+1);for(var i=0,j=Math.min(buf.length-offset,4);j>i;i++)buf[offset+i]=value>>>8*(littleEndian?i:3-i)&255}function checkIEEE754(buf,value,offset,ext,max,min){if(value>max||min>value)throw new RangeError("value is out of bounds");if(offset+ext>buf.length)throw new RangeError("index out of range");if(0>offset)throw new RangeError("index out of range")}function writeFloat(buf,value,offset,littleEndian,noAssert){return noAssert||checkIEEE754(buf,value,offset,4,3.4028234663852886e38,-3.4028234663852886e38),ieee754.write(buf,value,offset,littleEndian,23,4),offset+4}function writeDouble(buf,value,offset,littleEndian,noAssert){return noAssert||checkIEEE754(buf,value,offset,8,1.7976931348623157e308,-1.7976931348623157e308),ieee754.write(buf,value,offset,littleEndian,52,8),offset+8}function base64clean(str){if(str=stringtrim(str).replace(INVALID_BASE64_RE,""),str.length<2)return"";for(;str.length%4!==0;)str+="=";return str}function stringtrim(str){return str.trim?str.trim():str.replace(/^\s+|\s+$/g,"")}function toHex(n){return 16>n?"0"+n.toString(16):n.toString(16)}function utf8ToBytes(string,units){units=units||1/0;for(var codePoint,length=string.length,leadSurrogate=null,bytes=[],i=0;length>i;i++){if(codePoint=string.charCodeAt(i),codePoint>55295&&57344>codePoint){if(!leadSurrogate){if(codePoint>56319){(units-=3)>-1&&bytes.push(239,191,189);continue}if(i+1===length){(units-=3)>-1&&bytes.push(239,191,189);continue}leadSurrogate=codePoint;continue}if(56320>codePoint){(units-=3)>-1&&bytes.push(239,191,189),leadSurrogate=codePoint;continue}codePoint=leadSurrogate-55296<<10|codePoint-56320|65536,leadSurrogate=null}else leadSurrogate&&((units-=3)>-1&&bytes.push(239,191,189),leadSurrogate=null);if(128>codePoint){if((units-=1)<0)break;bytes.push(codePoint)}else if(2048>codePoint){if((units-=2)<0)break;bytes.push(codePoint>>6|192,63&codePoint|128)}else if(65536>codePoint){if((units-=3)<0)break;bytes.push(codePoint>>12|224,codePoint>>6&63|128,63&codePoint|128)}else{if(!(2097152>codePoint))throw new Error("Invalid code point");if((units-=4)<0)break;bytes.push(codePoint>>18|240,codePoint>>12&63|128,codePoint>>6&63|128,63&codePoint|128)}}return bytes}function asciiToBytes(str){for(var byteArray=[],i=0;i<str.length;i++)byteArray.push(255&str.charCodeAt(i));return byteArray}function utf16leToBytes(str,units){for(var c,hi,lo,byteArray=[],i=0;i<str.length&&!((units-=2)<0);i++)c=str.charCodeAt(i),hi=c>>8,lo=c%256,byteArray.push(lo),byteArray.push(hi);return byteArray}function base64ToBytes(str){return base64.toByteArray(base64clean(str))}function blitBuffer(src,dst,offset,length){for(var i=0;length>i&&!(i+offset>=dst.length||i>=src.length);i++)dst[i+offset]=src[i];return i}function decodeUtf8Char(str){try{return decodeURIComponent(str)}catch(err){return String.fromCharCode(65533)}}var base64=require("base64-js"),ieee754=require("ieee754"),isArray=require("is-array");exports.Buffer=Buffer,exports.SlowBuffer=SlowBuffer,exports.INSPECT_MAX_BYTES=50,Buffer.poolSize=8192;var kMaxLength=1073741823,rootParent={};Buffer.TYPED_ARRAY_SUPPORT=function(){try{var buf=new ArrayBuffer(0),arr=new Uint8Array(buf);return arr.foo=function(){return 42},42===arr.foo()&&"function"==typeof arr.subarray&&0===new Uint8Array(1).subarray(1,1).byteLength}catch(e){return!1}}(),Buffer.isBuffer=function(b){return!(null==b||!b._isBuffer)},Buffer.compare=function(a,b){if(!Buffer.isBuffer(a)||!Buffer.isBuffer(b))throw new TypeError("Arguments must be Buffers");if(a===b)return 0;for(var x=a.length,y=b.length,i=0,len=Math.min(x,y);len>i&&a[i]===b[i];)++i;return i!==len&&(x=a[i],y=b[i]),y>x?-1:x>y?1:0},Buffer.isEncoding=function(encoding){switch(String(encoding).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"binary":case"base64":case"raw":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return!0;default:return!1}},Buffer.concat=function(list,length){if(!isArray(list))throw new TypeError("list argument must be an Array of Buffers.");if(0===list.length)return new Buffer(0);if(1===list.length)return list[0];var i;if(void 0===length)for(length=0,i=0;i<list.length;i++)length+=list[i].length;var buf=new Buffer(length),pos=0;for(i=0;i<list.length;i++){var item=list[i];item.copy(buf,pos),pos+=item.length}return buf},Buffer.byteLength=byteLength,Buffer.prototype.length=void 0,Buffer.prototype.parent=void 0,Buffer.prototype.toString=function(encoding,start,end){var loweredCase=!1;if(start=0|start,end=void 0===end||end===1/0?this.length:0|end,encoding||(encoding="utf8"),0>start&&(start=0),end>this.length&&(end=this.length),start>=end)return"";
for(;;)switch(encoding){case"hex":return hexSlice(this,start,end);case"utf8":case"utf-8":return utf8Slice(this,start,end);case"ascii":return asciiSlice(this,start,end);case"binary":return binarySlice(this,start,end);case"base64":return base64Slice(this,start,end);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return utf16leSlice(this,start,end);default:if(loweredCase)throw new TypeError("Unknown encoding: "+encoding);encoding=(encoding+"").toLowerCase(),loweredCase=!0}},Buffer.prototype.equals=function(b){if(!Buffer.isBuffer(b))throw new TypeError("Argument must be a Buffer");return this===b?!0:0===Buffer.compare(this,b)},Buffer.prototype.inspect=function(){var str="",max=exports.INSPECT_MAX_BYTES;return this.length>0&&(str=this.toString("hex",0,max).match(/.{2}/g).join(" "),this.length>max&&(str+=" ... ")),"<Buffer "+str+">"},Buffer.prototype.compare=function(b){if(!Buffer.isBuffer(b))throw new TypeError("Argument must be a Buffer");return this===b?0:Buffer.compare(this,b)},Buffer.prototype.indexOf=function(val,byteOffset){function arrayIndexOf(arr,val,byteOffset){for(var foundIndex=-1,i=0;byteOffset+i<arr.length;i++)if(arr[byteOffset+i]===val[-1===foundIndex?0:i-foundIndex]){if(-1===foundIndex&&(foundIndex=i),i-foundIndex+1===val.length)return byteOffset+foundIndex}else foundIndex=-1;return-1}if(byteOffset>2147483647?byteOffset=2147483647:-2147483648>byteOffset&&(byteOffset=-2147483648),byteOffset>>=0,0===this.length)return-1;if(byteOffset>=this.length)return-1;if(0>byteOffset&&(byteOffset=Math.max(this.length+byteOffset,0)),"string"==typeof val)return 0===val.length?-1:String.prototype.indexOf.call(this,val,byteOffset);if(Buffer.isBuffer(val))return arrayIndexOf(this,val,byteOffset);if("number"==typeof val)return Buffer.TYPED_ARRAY_SUPPORT&&"function"===Uint8Array.prototype.indexOf?Uint8Array.prototype.indexOf.call(this,val,byteOffset):arrayIndexOf(this,[val],byteOffset);throw new TypeError("val must be string, number or Buffer")},Buffer.prototype.get=function(offset){return console.log(".get() is deprecated. Access using array indexes instead."),this.readUInt8(offset)},Buffer.prototype.set=function(v,offset){return console.log(".set() is deprecated. Access using array indexes instead."),this.writeUInt8(v,offset)},Buffer.prototype.write=function(string,offset,length,encoding){if(void 0===offset)encoding="utf8",length=this.length,offset=0;else if(void 0===length&&"string"==typeof offset)encoding=offset,length=this.length,offset=0;else if(isFinite(offset))offset=0|offset,isFinite(length)?(length=0|length,void 0===encoding&&(encoding="utf8")):(encoding=length,length=void 0);else{var swap=encoding;encoding=offset,offset=0|length,length=swap}var remaining=this.length-offset;if((void 0===length||length>remaining)&&(length=remaining),string.length>0&&(0>length||0>offset)||offset>this.length)throw new RangeError("attempt to write outside buffer bounds");encoding||(encoding="utf8");for(var loweredCase=!1;;)switch(encoding){case"hex":return hexWrite(this,string,offset,length);case"utf8":case"utf-8":return utf8Write(this,string,offset,length);case"ascii":return asciiWrite(this,string,offset,length);case"binary":return binaryWrite(this,string,offset,length);case"base64":return base64Write(this,string,offset,length);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return ucs2Write(this,string,offset,length);default:if(loweredCase)throw new TypeError("Unknown encoding: "+encoding);encoding=(""+encoding).toLowerCase(),loweredCase=!0}},Buffer.prototype.toJSON=function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}},Buffer.prototype.slice=function(start,end){var len=this.length;start=~~start,end=void 0===end?len:~~end,0>start?(start+=len,0>start&&(start=0)):start>len&&(start=len),0>end?(end+=len,0>end&&(end=0)):end>len&&(end=len),start>end&&(end=start);var newBuf;if(Buffer.TYPED_ARRAY_SUPPORT)newBuf=Buffer._augment(this.subarray(start,end));else{var sliceLen=end-start;newBuf=new Buffer(sliceLen,void 0);for(var i=0;sliceLen>i;i++)newBuf[i]=this[i+start]}return newBuf.length&&(newBuf.parent=this.parent||this),newBuf},Buffer.prototype.readUIntLE=function(offset,byteLength,noAssert){offset=0|offset,byteLength=0|byteLength,noAssert||checkOffset(offset,byteLength,this.length);for(var val=this[offset],mul=1,i=0;++i<byteLength&&(mul*=256);)val+=this[offset+i]*mul;return val},Buffer.prototype.readUIntBE=function(offset,byteLength,noAssert){offset=0|offset,byteLength=0|byteLength,noAssert||checkOffset(offset,byteLength,this.length);for(var val=this[offset+--byteLength],mul=1;byteLength>0&&(mul*=256);)val+=this[offset+--byteLength]*mul;return val},Buffer.prototype.readUInt8=function(offset,noAssert){return noAssert||checkOffset(offset,1,this.length),this[offset]},Buffer.prototype.readUInt16LE=function(offset,noAssert){return noAssert||checkOffset(offset,2,this.length),this[offset]|this[offset+1]<<8},Buffer.prototype.readUInt16BE=function(offset,noAssert){return noAssert||checkOffset(offset,2,this.length),this[offset]<<8|this[offset+1]},Buffer.prototype.readUInt32LE=function(offset,noAssert){return noAssert||checkOffset(offset,4,this.length),(this[offset]|this[offset+1]<<8|this[offset+2]<<16)+16777216*this[offset+3]},Buffer.prototype.readUInt32BE=function(offset,noAssert){return noAssert||checkOffset(offset,4,this.length),16777216*this[offset]+(this[offset+1]<<16|this[offset+2]<<8|this[offset+3])},Buffer.prototype.readIntLE=function(offset,byteLength,noAssert){offset=0|offset,byteLength=0|byteLength,noAssert||checkOffset(offset,byteLength,this.length);for(var val=this[offset],mul=1,i=0;++i<byteLength&&(mul*=256);)val+=this[offset+i]*mul;return mul*=128,val>=mul&&(val-=Math.pow(2,8*byteLength)),val},Buffer.prototype.readIntBE=function(offset,byteLength,noAssert){offset=0|offset,byteLength=0|byteLength,noAssert||checkOffset(offset,byteLength,this.length);for(var i=byteLength,mul=1,val=this[offset+--i];i>0&&(mul*=256);)val+=this[offset+--i]*mul;return mul*=128,val>=mul&&(val-=Math.pow(2,8*byteLength)),val},Buffer.prototype.readInt8=function(offset,noAssert){return noAssert||checkOffset(offset,1,this.length),128&this[offset]?-1*(255-this[offset]+1):this[offset]},Buffer.prototype.readInt16LE=function(offset,noAssert){noAssert||checkOffset(offset,2,this.length);var val=this[offset]|this[offset+1]<<8;return 32768&val?4294901760|val:val},Buffer.prototype.readInt16BE=function(offset,noAssert){noAssert||checkOffset(offset,2,this.length);var val=this[offset+1]|this[offset]<<8;return 32768&val?4294901760|val:val},Buffer.prototype.readInt32LE=function(offset,noAssert){return noAssert||checkOffset(offset,4,this.length),this[offset]|this[offset+1]<<8|this[offset+2]<<16|this[offset+3]<<24},Buffer.prototype.readInt32BE=function(offset,noAssert){return noAssert||checkOffset(offset,4,this.length),this[offset]<<24|this[offset+1]<<16|this[offset+2]<<8|this[offset+3]},Buffer.prototype.readFloatLE=function(offset,noAssert){return noAssert||checkOffset(offset,4,this.length),ieee754.read(this,offset,!0,23,4)},Buffer.prototype.readFloatBE=function(offset,noAssert){return noAssert||checkOffset(offset,4,this.length),ieee754.read(this,offset,!1,23,4)},Buffer.prototype.readDoubleLE=function(offset,noAssert){return noAssert||checkOffset(offset,8,this.length),ieee754.read(this,offset,!0,52,8)},Buffer.prototype.readDoubleBE=function(offset,noAssert){return noAssert||checkOffset(offset,8,this.length),ieee754.read(this,offset,!1,52,8)},Buffer.prototype.writeUIntLE=function(value,offset,byteLength,noAssert){value=+value,offset=0|offset,byteLength=0|byteLength,noAssert||checkInt(this,value,offset,byteLength,Math.pow(2,8*byteLength),0);var mul=1,i=0;for(this[offset]=255&value;++i<byteLength&&(mul*=256);)this[offset+i]=value/mul&255;return offset+byteLength},Buffer.prototype.writeUIntBE=function(value,offset,byteLength,noAssert){value=+value,offset=0|offset,byteLength=0|byteLength,noAssert||checkInt(this,value,offset,byteLength,Math.pow(2,8*byteLength),0);var i=byteLength-1,mul=1;for(this[offset+i]=255&value;--i>=0&&(mul*=256);)this[offset+i]=value/mul&255;return offset+byteLength},Buffer.prototype.writeUInt8=function(value,offset,noAssert){return value=+value,offset=0|offset,noAssert||checkInt(this,value,offset,1,255,0),Buffer.TYPED_ARRAY_SUPPORT||(value=Math.floor(value)),this[offset]=value,offset+1},Buffer.prototype.writeUInt16LE=function(value,offset,noAssert){return value=+value,offset=0|offset,noAssert||checkInt(this,value,offset,2,65535,0),Buffer.TYPED_ARRAY_SUPPORT?(this[offset]=value,this[offset+1]=value>>>8):objectWriteUInt16(this,value,offset,!0),offset+2},Buffer.prototype.writeUInt16BE=function(value,offset,noAssert){return value=+value,offset=0|offset,noAssert||checkInt(this,value,offset,2,65535,0),Buffer.TYPED_ARRAY_SUPPORT?(this[offset]=value>>>8,this[offset+1]=value):objectWriteUInt16(this,value,offset,!1),offset+2},Buffer.prototype.writeUInt32LE=function(value,offset,noAssert){return value=+value,offset=0|offset,noAssert||checkInt(this,value,offset,4,4294967295,0),Buffer.TYPED_ARRAY_SUPPORT?(this[offset+3]=value>>>24,this[offset+2]=value>>>16,this[offset+1]=value>>>8,this[offset]=value):objectWriteUInt32(this,value,offset,!0),offset+4},Buffer.prototype.writeUInt32BE=function(value,offset,noAssert){return value=+value,offset=0|offset,noAssert||checkInt(this,value,offset,4,4294967295,0),Buffer.TYPED_ARRAY_SUPPORT?(this[offset]=value>>>24,this[offset+1]=value>>>16,this[offset+2]=value>>>8,this[offset+3]=value):objectWriteUInt32(this,value,offset,!1),offset+4},Buffer.prototype.writeIntLE=function(value,offset,byteLength,noAssert){if(value=+value,offset=0|offset,!noAssert){var limit=Math.pow(2,8*byteLength-1);checkInt(this,value,offset,byteLength,limit-1,-limit)}var i=0,mul=1,sub=0>value?1:0;for(this[offset]=255&value;++i<byteLength&&(mul*=256);)this[offset+i]=(value/mul>>0)-sub&255;return offset+byteLength},Buffer.prototype.writeIntBE=function(value,offset,byteLength,noAssert){if(value=+value,offset=0|offset,!noAssert){var limit=Math.pow(2,8*byteLength-1);checkInt(this,value,offset,byteLength,limit-1,-limit)}var i=byteLength-1,mul=1,sub=0>value?1:0;for(this[offset+i]=255&value;--i>=0&&(mul*=256);)this[offset+i]=(value/mul>>0)-sub&255;return offset+byteLength},Buffer.prototype.writeInt8=function(value,offset,noAssert){return value=+value,offset=0|offset,noAssert||checkInt(this,value,offset,1,127,-128),Buffer.TYPED_ARRAY_SUPPORT||(value=Math.floor(value)),0>value&&(value=255+value+1),this[offset]=value,offset+1},Buffer.prototype.writeInt16LE=function(value,offset,noAssert){return value=+value,offset=0|offset,noAssert||checkInt(this,value,offset,2,32767,-32768),Buffer.TYPED_ARRAY_SUPPORT?(this[offset]=value,this[offset+1]=value>>>8):objectWriteUInt16(this,value,offset,!0),offset+2},Buffer.prototype.writeInt16BE=function(value,offset,noAssert){return value=+value,offset=0|offset,noAssert||checkInt(this,value,offset,2,32767,-32768),Buffer.TYPED_ARRAY_SUPPORT?(this[offset]=value>>>8,this[offset+1]=value):objectWriteUInt16(this,value,offset,!1),offset+2},Buffer.prototype.writeInt32LE=function(value,offset,noAssert){return value=+value,offset=0|offset,noAssert||checkInt(this,value,offset,4,2147483647,-2147483648),Buffer.TYPED_ARRAY_SUPPORT?(this[offset]=value,this[offset+1]=value>>>8,this[offset+2]=value>>>16,this[offset+3]=value>>>24):objectWriteUInt32(this,value,offset,!0),offset+4},Buffer.prototype.writeInt32BE=function(value,offset,noAssert){return value=+value,offset=0|offset,noAssert||checkInt(this,value,offset,4,2147483647,-2147483648),0>value&&(value=4294967295+value+1),Buffer.TYPED_ARRAY_SUPPORT?(this[offset]=value>>>24,this[offset+1]=value>>>16,this[offset+2]=value>>>8,this[offset+3]=value):objectWriteUInt32(this,value,offset,!1),offset+4},Buffer.prototype.writeFloatLE=function(value,offset,noAssert){return writeFloat(this,value,offset,!0,noAssert)},Buffer.prototype.writeFloatBE=function(value,offset,noAssert){return writeFloat(this,value,offset,!1,noAssert)},Buffer.prototype.writeDoubleLE=function(value,offset,noAssert){return writeDouble(this,value,offset,!0,noAssert)},Buffer.prototype.writeDoubleBE=function(value,offset,noAssert){return writeDouble(this,value,offset,!1,noAssert)},Buffer.prototype.copy=function(target,targetStart,start,end){if(start||(start=0),end||0===end||(end=this.length),targetStart>=target.length&&(targetStart=target.length),targetStart||(targetStart=0),end>0&&start>end&&(end=start),end===start)return 0;if(0===target.length||0===this.length)return 0;if(0>targetStart)throw new RangeError("targetStart out of bounds");if(0>start||start>=this.length)throw new RangeError("sourceStart out of bounds");if(0>end)throw new RangeError("sourceEnd out of bounds");end>this.length&&(end=this.length),target.length-targetStart<end-start&&(end=target.length-targetStart+start);var len=end-start;if(1e3>len||!Buffer.TYPED_ARRAY_SUPPORT)for(var i=0;len>i;i++)target[i+targetStart]=this[i+start];else target._set(this.subarray(start,start+len),targetStart);return len},Buffer.prototype.fill=function(value,start,end){if(value||(value=0),start||(start=0),end||(end=this.length),start>end)throw new RangeError("end < start");if(end!==start&&0!==this.length){if(0>start||start>=this.length)throw new RangeError("start out of bounds");if(0>end||end>this.length)throw new RangeError("end out of bounds");var i;if("number"==typeof value)for(i=start;end>i;i++)this[i]=value;else{var bytes=utf8ToBytes(value.toString()),len=bytes.length;for(i=start;end>i;i++)this[i]=bytes[i%len]}return this}},Buffer.prototype.toArrayBuffer=function(){if("undefined"!=typeof Uint8Array){if(Buffer.TYPED_ARRAY_SUPPORT)return new Buffer(this).buffer;for(var buf=new Uint8Array(this.length),i=0,len=buf.length;len>i;i+=1)buf[i]=this[i];return buf.buffer}throw new TypeError("Buffer.toArrayBuffer not supported in this browser")};var BP=Buffer.prototype;Buffer._augment=function(arr){return arr.constructor=Buffer,arr._isBuffer=!0,arr._set=arr.set,arr.get=BP.get,arr.set=BP.set,arr.write=BP.write,arr.toString=BP.toString,arr.toLocaleString=BP.toString,arr.toJSON=BP.toJSON,arr.equals=BP.equals,arr.compare=BP.compare,arr.indexOf=BP.indexOf,arr.copy=BP.copy,arr.slice=BP.slice,arr.readUIntLE=BP.readUIntLE,arr.readUIntBE=BP.readUIntBE,arr.readUInt8=BP.readUInt8,arr.readUInt16LE=BP.readUInt16LE,arr.readUInt16BE=BP.readUInt16BE,arr.readUInt32LE=BP.readUInt32LE,arr.readUInt32BE=BP.readUInt32BE,arr.readIntLE=BP.readIntLE,arr.readIntBE=BP.readIntBE,arr.readInt8=BP.readInt8,arr.readInt16LE=BP.readInt16LE,arr.readInt16BE=BP.readInt16BE,arr.readInt32LE=BP.readInt32LE,arr.readInt32BE=BP.readInt32BE,arr.readFloatLE=BP.readFloatLE,arr.readFloatBE=BP.readFloatBE,arr.readDoubleLE=BP.readDoubleLE,arr.readDoubleBE=BP.readDoubleBE,arr.writeUInt8=BP.writeUInt8,arr.writeUIntLE=BP.writeUIntLE,arr.writeUIntBE=BP.writeUIntBE,arr.writeUInt16LE=BP.writeUInt16LE,arr.writeUInt16BE=BP.writeUInt16BE,arr.writeUInt32LE=BP.writeUInt32LE,arr.writeUInt32BE=BP.writeUInt32BE,arr.writeIntLE=BP.writeIntLE,arr.writeIntBE=BP.writeIntBE,arr.writeInt8=BP.writeInt8,arr.writeInt16LE=BP.writeInt16LE,arr.writeInt16BE=BP.writeInt16BE,arr.writeInt32LE=BP.writeInt32LE,arr.writeInt32BE=BP.writeInt32BE,arr.writeFloatLE=BP.writeFloatLE,arr.writeFloatBE=BP.writeFloatBE,arr.writeDoubleLE=BP.writeDoubleLE,arr.writeDoubleBE=BP.writeDoubleBE,arr.fill=BP.fill,arr.inspect=BP.inspect,arr.toArrayBuffer=BP.toArrayBuffer,arr};var INVALID_BASE64_RE=/[^+\/0-9A-z\-]/g},{"base64-js":3,ieee754:4,"is-array":5}],3:[function(require,module,exports){var lookup="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";!function(exports){"use strict";function decode(elt){var code=elt.charCodeAt(0);return code===PLUS||code===PLUS_URL_SAFE?62:code===SLASH||code===SLASH_URL_SAFE?63:NUMBER>code?-1:NUMBER+10>code?code-NUMBER+26+26:UPPER+26>code?code-UPPER:LOWER+26>code?code-LOWER+26:void 0}function b64ToByteArray(b64){function push(v){arr[L++]=v}var i,j,l,tmp,placeHolders,arr;if(b64.length%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var len=b64.length;placeHolders="="===b64.charAt(len-2)?2:"="===b64.charAt(len-1)?1:0,arr=new Arr(3*b64.length/4-placeHolders),l=placeHolders>0?b64.length-4:b64.length;var L=0;for(i=0,j=0;l>i;i+=4,j+=3)tmp=decode(b64.charAt(i))<<18|decode(b64.charAt(i+1))<<12|decode(b64.charAt(i+2))<<6|decode(b64.charAt(i+3)),push((16711680&tmp)>>16),push((65280&tmp)>>8),push(255&tmp);return 2===placeHolders?(tmp=decode(b64.charAt(i))<<2|decode(b64.charAt(i+1))>>4,push(255&tmp)):1===placeHolders&&(tmp=decode(b64.charAt(i))<<10|decode(b64.charAt(i+1))<<4|decode(b64.charAt(i+2))>>2,push(tmp>>8&255),push(255&tmp)),arr}function uint8ToBase64(uint8){function encode(num){return lookup.charAt(num)}function tripletToBase64(num){return encode(num>>18&63)+encode(num>>12&63)+encode(num>>6&63)+encode(63&num)}var i,temp,length,extraBytes=uint8.length%3,output="";for(i=0,length=uint8.length-extraBytes;length>i;i+=3)temp=(uint8[i]<<16)+(uint8[i+1]<<8)+uint8[i+2],output+=tripletToBase64(temp);switch(extraBytes){case 1:temp=uint8[uint8.length-1],output+=encode(temp>>2),output+=encode(temp<<4&63),output+="==";break;case 2:temp=(uint8[uint8.length-2]<<8)+uint8[uint8.length-1],output+=encode(temp>>10),output+=encode(temp>>4&63),output+=encode(temp<<2&63),output+="="}return output}var Arr="undefined"!=typeof Uint8Array?Uint8Array:Array,PLUS="+".charCodeAt(0),SLASH="/".charCodeAt(0),NUMBER="0".charCodeAt(0),LOWER="a".charCodeAt(0),UPPER="A".charCodeAt(0),PLUS_URL_SAFE="-".charCodeAt(0),SLASH_URL_SAFE="_".charCodeAt(0);exports.toByteArray=b64ToByteArray,exports.fromByteArray=uint8ToBase64}("undefined"==typeof exports?this.base64js={}:exports)},{}],4:[function(require,module,exports){exports.read=function(buffer,offset,isLE,mLen,nBytes){var e,m,eLen=8*nBytes-mLen-1,eMax=(1<<eLen)-1,eBias=eMax>>1,nBits=-7,i=isLE?nBytes-1:0,d=isLE?-1:1,s=buffer[offset+i];for(i+=d,e=s&(1<<-nBits)-1,s>>=-nBits,nBits+=eLen;nBits>0;e=256*e+buffer[offset+i],i+=d,nBits-=8);for(m=e&(1<<-nBits)-1,e>>=-nBits,nBits+=mLen;nBits>0;m=256*m+buffer[offset+i],i+=d,nBits-=8);if(0===e)e=1-eBias;else{if(e===eMax)return m?NaN:(s?-1:1)*(1/0);m+=Math.pow(2,mLen),e-=eBias}return(s?-1:1)*m*Math.pow(2,e-mLen)},exports.write=function(buffer,value,offset,isLE,mLen,nBytes){var e,m,c,eLen=8*nBytes-mLen-1,eMax=(1<<eLen)-1,eBias=eMax>>1,rt=23===mLen?Math.pow(2,-24)-Math.pow(2,-77):0,i=isLE?0:nBytes-1,d=isLE?1:-1,s=0>value||0===value&&0>1/value?1:0;for(value=Math.abs(value),isNaN(value)||value===1/0?(m=isNaN(value)?1:0,e=eMax):(e=Math.floor(Math.log(value)/Math.LN2),value*(c=Math.pow(2,-e))<1&&(e--,c*=2),value+=e+eBias>=1?rt/c:rt*Math.pow(2,1-eBias),value*c>=2&&(e++,c/=2),e+eBias>=eMax?(m=0,e=eMax):e+eBias>=1?(m=(value*c-1)*Math.pow(2,mLen),e+=eBias):(m=value*Math.pow(2,eBias-1)*Math.pow(2,mLen),e=0));mLen>=8;buffer[offset+i]=255&m,i+=d,m/=256,mLen-=8);for(e=e<<mLen|m,eLen+=mLen;eLen>0;buffer[offset+i]=255&e,i+=d,e/=256,eLen-=8);buffer[offset+i-d]|=128*s}},{}],5:[function(require,module,exports){var isArray=Array.isArray,str=Object.prototype.toString;module.exports=isArray||function(val){return!!val&&"[object Array]"==str.call(val)}},{}],6:[function(require,module,exports){function EventEmitter(){this._events=this._events||{},this._maxListeners=this._maxListeners||void 0}function isFunction(arg){return"function"==typeof arg}function isNumber(arg){return"number"==typeof arg}function isObject(arg){return"object"==typeof arg&&null!==arg}function isUndefined(arg){return void 0===arg}module.exports=EventEmitter,EventEmitter.EventEmitter=EventEmitter,EventEmitter.prototype._events=void 0,EventEmitter.prototype._maxListeners=void 0,EventEmitter.defaultMaxListeners=10,EventEmitter.prototype.setMaxListeners=function(n){if(!isNumber(n)||0>n||isNaN(n))throw TypeError("n must be a positive number");return this._maxListeners=n,this},EventEmitter.prototype.emit=function(type){var er,handler,len,args,i,listeners;if(this._events||(this._events={}),"error"===type&&(!this._events.error||isObject(this._events.error)&&!this._events.error.length)){if(er=arguments[1],er instanceof Error)throw er;throw TypeError('Uncaught, unspecified "error" event.')}if(handler=this._events[type],isUndefined(handler))return!1;if(isFunction(handler))switch(arguments.length){case 1:handler.call(this);break;case 2:handler.call(this,arguments[1]);break;case 3:handler.call(this,arguments[1],arguments[2]);break;default:for(len=arguments.length,args=new Array(len-1),i=1;len>i;i++)args[i-1]=arguments[i];handler.apply(this,args)}else if(isObject(handler)){for(len=arguments.length,args=new Array(len-1),i=1;len>i;i++)args[i-1]=arguments[i];for(listeners=handler.slice(),len=listeners.length,i=0;len>i;i++)listeners[i].apply(this,args)}return!0},EventEmitter.prototype.addListener=function(type,listener){var m;if(!isFunction(listener))throw TypeError("listener must be a function");if(this._events||(this._events={}),this._events.newListener&&this.emit("newListener",type,isFunction(listener.listener)?listener.listener:listener),this._events[type]?isObject(this._events[type])?this._events[type].push(listener):this._events[type]=[this._events[type],listener]:this._events[type]=listener,isObject(this._events[type])&&!this._events[type].warned){var m;m=isUndefined(this._maxListeners)?EventEmitter.defaultMaxListeners:this._maxListeners,m&&m>0&&this._events[type].length>m&&(this._events[type].warned=!0,console.error("(node) warning: possible EventEmitter memory leak detected. %d listeners added. Use emitter.setMaxListeners() to increase limit.",this._events[type].length),"function"==typeof console.trace&&console.trace())}return this},EventEmitter.prototype.on=EventEmitter.prototype.addListener,EventEmitter.prototype.once=function(type,listener){function g(){this.removeListener(type,g),fired||(fired=!0,listener.apply(this,arguments))}if(!isFunction(listener))throw TypeError("listener must be a function");var fired=!1;return g.listener=listener,this.on(type,g),this},EventEmitter.prototype.removeListener=function(type,listener){var list,position,length,i;if(!isFunction(listener))throw TypeError("listener must be a function");if(!this._events||!this._events[type])return this;if(list=this._events[type],length=list.length,position=-1,list===listener||isFunction(list.listener)&&list.listener===listener)delete this._events[type],this._events.removeListener&&this.emit("removeListener",type,listener);else if(isObject(list)){for(i=length;i-->0;)if(list[i]===listener||list[i].listener&&list[i].listener===listener){position=i;break}if(0>position)return this;1===list.length?(list.length=0,delete this._events[type]):list.splice(position,1),this._events.removeListener&&this.emit("removeListener",type,listener)}return this},EventEmitter.prototype.removeAllListeners=function(type){var key,listeners;if(!this._events)return this;if(!this._events.removeListener)return 0===arguments.length?this._events={}:this._events[type]&&delete this._events[type],this;if(0===arguments.length){for(key in this._events)"removeListener"!==key&&this.removeAllListeners(key);return this.removeAllListeners("removeListener"),this._events={},this}if(listeners=this._events[type],isFunction(listeners))this.removeListener(type,listeners);else for(;listeners.length;)this.removeListener(type,listeners[listeners.length-1]);return delete this._events[type],this},EventEmitter.prototype.listeners=function(type){var ret;return ret=this._events&&this._events[type]?isFunction(this._events[type])?[this._events[type]]:this._events[type].slice():[]},EventEmitter.listenerCount=function(emitter,type){var ret;return ret=emitter._events&&emitter._events[type]?isFunction(emitter._events[type])?1:emitter._events[type].length:0}},{}],7:[function(require,module,exports){"function"==typeof Object.create?module.exports=function(ctor,superCtor){ctor.super_=superCtor,ctor.prototype=Object.create(superCtor.prototype,{constructor:{value:ctor,enumerable:!1,writable:!0,configurable:!0}})}:module.exports=function(ctor,superCtor){ctor.super_=superCtor;var TempCtor=function(){};TempCtor.prototype=superCtor.prototype,ctor.prototype=new TempCtor,ctor.prototype.constructor=ctor}},{}],8:[function(require,module,exports){function cleanUpNextTick(){draining=!1,currentQueue.length?queue=currentQueue.concat(queue):queueIndex=-1,queue.length&&drainQueue()}function drainQueue(){if(!draining){var timeout=setTimeout(cleanUpNextTick);draining=!0;for(var len=queue.length;len;){for(currentQueue=queue,queue=[];++queueIndex<len;)currentQueue[queueIndex].run();queueIndex=-1,len=queue.length}currentQueue=null,draining=!1,clearTimeout(timeout)}}function Item(fun,array){this.fun=fun,this.array=array}function noop(){}var currentQueue,process=module.exports={},queue=[],draining=!1,queueIndex=-1;process.nextTick=function(fun){var args=new Array(arguments.length-1);if(arguments.length>1)for(var i=1;i<arguments.length;i++)args[i-1]=arguments[i];queue.push(new Item(fun,args)),1!==queue.length||draining||setTimeout(drainQueue,0)},Item.prototype.run=function(){this.fun.apply(null,this.array)},process.title="browser",process.browser=!0,process.env={},process.argv=[],process.version="",process.versions={},process.on=noop,process.addListener=noop,process.once=noop,process.off=noop,process.removeListener=noop,process.removeAllListeners=noop,process.emit=noop,process.binding=function(name){throw new Error("process.binding is not supported")},process.cwd=function(){return"/"},process.chdir=function(dir){throw new Error("process.chdir is not supported")},process.umask=function(){return 0}},{}],9:[function(require,module,exports){module.exports=function(arg){return arg&&"object"==typeof arg&&"function"==typeof arg.copy&&"function"==typeof arg.fill&&"function"==typeof arg.readUInt8}},{}],10:[function(require,module,exports){(function(process,global){function inspect(obj,opts){var ctx={seen:[],stylize:stylizeNoColor};return arguments.length>=3&&(ctx.depth=arguments[2]),arguments.length>=4&&(ctx.colors=arguments[3]),isBoolean(opts)?ctx.showHidden=opts:opts&&exports._extend(ctx,opts),isUndefined(ctx.showHidden)&&(ctx.showHidden=!1),isUndefined(ctx.depth)&&(ctx.depth=2),isUndefined(ctx.colors)&&(ctx.colors=!1),isUndefined(ctx.customInspect)&&(ctx.customInspect=!0),ctx.colors&&(ctx.stylize=stylizeWithColor),formatValue(ctx,obj,ctx.depth)}function stylizeWithColor(str,styleType){var style=inspect.styles[styleType];return style?"["+inspect.colors[style][0]+"m"+str+"["+inspect.colors[style][1]+"m":str}function stylizeNoColor(str,styleType){return str}function arrayToHash(array){var hash={};return array.forEach(function(val,idx){hash[val]=!0}),hash}function formatValue(ctx,value,recurseTimes){if(ctx.customInspect&&value&&isFunction(value.inspect)&&value.inspect!==exports.inspect&&(!value.constructor||value.constructor.prototype!==value)){var ret=value.inspect(recurseTimes,ctx);return isString(ret)||(ret=formatValue(ctx,ret,recurseTimes)),ret}var primitive=formatPrimitive(ctx,value);if(primitive)return primitive;var keys=Object.keys(value),visibleKeys=arrayToHash(keys);if(ctx.showHidden&&(keys=Object.getOwnPropertyNames(value)),isError(value)&&(keys.indexOf("message")>=0||keys.indexOf("description")>=0))return formatError(value);if(0===keys.length){if(isFunction(value)){var name=value.name?": "+value.name:"";return ctx.stylize("[Function"+name+"]","special")}if(isRegExp(value))return ctx.stylize(RegExp.prototype.toString.call(value),"regexp");if(isDate(value))return ctx.stylize(Date.prototype.toString.call(value),"date");if(isError(value))return formatError(value)}var base="",array=!1,braces=["{","}"];if(isArray(value)&&(array=!0,braces=["[","]"]),isFunction(value)){var n=value.name?": "+value.name:"";base=" [Function"+n+"]"}if(isRegExp(value)&&(base=" "+RegExp.prototype.toString.call(value)),isDate(value)&&(base=" "+Date.prototype.toUTCString.call(value)),isError(value)&&(base=" "+formatError(value)),0===keys.length&&(!array||0==value.length))return braces[0]+base+braces[1];if(0>recurseTimes)return isRegExp(value)?ctx.stylize(RegExp.prototype.toString.call(value),"regexp"):ctx.stylize("[Object]","special");ctx.seen.push(value);var output;return output=array?formatArray(ctx,value,recurseTimes,visibleKeys,keys):keys.map(function(key){return formatProperty(ctx,value,recurseTimes,visibleKeys,key,array)}),ctx.seen.pop(),reduceToSingleString(output,base,braces)}function formatPrimitive(ctx,value){if(isUndefined(value))return ctx.stylize("undefined","undefined");if(isString(value)){var simple="'"+JSON.stringify(value).replace(/^"|"$/g,"").replace(/'/g,"\\'").replace(/\\"/g,'"')+"'";return ctx.stylize(simple,"string")}return isNumber(value)?ctx.stylize(""+value,"number"):isBoolean(value)?ctx.stylize(""+value,"boolean"):isNull(value)?ctx.stylize("null","null"):void 0}function formatError(value){return"["+Error.prototype.toString.call(value)+"]"}function formatArray(ctx,value,recurseTimes,visibleKeys,keys){for(var output=[],i=0,l=value.length;l>i;++i)hasOwnProperty(value,String(i))?output.push(formatProperty(ctx,value,recurseTimes,visibleKeys,String(i),!0)):output.push("");return keys.forEach(function(key){key.match(/^\d+$/)||output.push(formatProperty(ctx,value,recurseTimes,visibleKeys,key,!0))}),output}function formatProperty(ctx,value,recurseTimes,visibleKeys,key,array){var name,str,desc;if(desc=Object.getOwnPropertyDescriptor(value,key)||{value:value[key]},desc.get?str=desc.set?ctx.stylize("[Getter/Setter]","special"):ctx.stylize("[Getter]","special"):desc.set&&(str=ctx.stylize("[Setter]","special")),hasOwnProperty(visibleKeys,key)||(name="["+key+"]"),str||(ctx.seen.indexOf(desc.value)<0?(str=isNull(recurseTimes)?formatValue(ctx,desc.value,null):formatValue(ctx,desc.value,recurseTimes-1),str.indexOf("\n")>-1&&(str=array?str.split("\n").map(function(line){return"  "+line}).join("\n").substr(2):"\n"+str.split("\n").map(function(line){return"   "+line}).join("\n"))):str=ctx.stylize("[Circular]","special")),isUndefined(name)){if(array&&key.match(/^\d+$/))return str;name=JSON.stringify(""+key),name.match(/^"([a-zA-Z_][a-zA-Z_0-9]*)"$/)?(name=name.substr(1,name.length-2),name=ctx.stylize(name,"name")):(name=name.replace(/'/g,"\\'").replace(/\\"/g,'"').replace(/(^"|"$)/g,"'"),name=ctx.stylize(name,"string"))}return name+": "+str}function reduceToSingleString(output,base,braces){var numLinesEst=0,length=output.reduce(function(prev,cur){return numLinesEst++,cur.indexOf("\n")>=0&&numLinesEst++,prev+cur.replace(/\u001b\[\d\d?m/g,"").length+1},0);return length>60?braces[0]+(""===base?"":base+"\n ")+" "+output.join(",\n  ")+" "+braces[1]:braces[0]+base+" "+output.join(", ")+" "+braces[1]}function isArray(ar){return Array.isArray(ar)}function isBoolean(arg){return"boolean"==typeof arg}function isNull(arg){return null===arg}function isNullOrUndefined(arg){return null==arg}function isNumber(arg){return"number"==typeof arg}function isString(arg){return"string"==typeof arg}function isSymbol(arg){return"symbol"==typeof arg}function isUndefined(arg){return void 0===arg}function isRegExp(re){return isObject(re)&&"[object RegExp]"===objectToString(re)}function isObject(arg){return"object"==typeof arg&&null!==arg}function isDate(d){return isObject(d)&&"[object Date]"===objectToString(d)}function isError(e){return isObject(e)&&("[object Error]"===objectToString(e)||e instanceof Error)}function isFunction(arg){return"function"==typeof arg}function isPrimitive(arg){return null===arg||"boolean"==typeof arg||"number"==typeof arg||"string"==typeof arg||"symbol"==typeof arg||"undefined"==typeof arg}function objectToString(o){return Object.prototype.toString.call(o)}function pad(n){return 10>n?"0"+n.toString(10):n.toString(10)}function timestamp(){var d=new Date,time=[pad(d.getHours()),pad(d.getMinutes()),pad(d.getSeconds())].join(":");return[d.getDate(),months[d.getMonth()],time].join(" ")}function hasOwnProperty(obj,prop){return Object.prototype.hasOwnProperty.call(obj,prop)}var formatRegExp=/%[sdj%]/g;exports.format=function(f){if(!isString(f)){for(var objects=[],i=0;i<arguments.length;i++)objects.push(inspect(arguments[i]));
return objects.join(" ")}for(var i=1,args=arguments,len=args.length,str=String(f).replace(formatRegExp,function(x){if("%%"===x)return"%";if(i>=len)return x;switch(x){case"%s":return String(args[i++]);case"%d":return Number(args[i++]);case"%j":try{return JSON.stringify(args[i++])}catch(_){return"[Circular]"}default:return x}}),x=args[i];len>i;x=args[++i])str+=isNull(x)||!isObject(x)?" "+x:" "+inspect(x);return str},exports.deprecate=function(fn,msg){function deprecated(){if(!warned){if(process.throwDeprecation)throw new Error(msg);process.traceDeprecation?console.trace(msg):console.error(msg),warned=!0}return fn.apply(this,arguments)}if(isUndefined(global.process))return function(){return exports.deprecate(fn,msg).apply(this,arguments)};if(process.noDeprecation===!0)return fn;var warned=!1;return deprecated};var debugEnviron,debugs={};exports.debuglog=function(set){if(isUndefined(debugEnviron)&&(debugEnviron=process.env.NODE_DEBUG||""),set=set.toUpperCase(),!debugs[set])if(new RegExp("\\b"+set+"\\b","i").test(debugEnviron)){var pid=process.pid;debugs[set]=function(){var msg=exports.format.apply(exports,arguments);console.error("%s %d: %s",set,pid,msg)}}else debugs[set]=function(){};return debugs[set]},exports.inspect=inspect,inspect.colors={bold:[1,22],italic:[3,23],underline:[4,24],inverse:[7,27],white:[37,39],grey:[90,39],black:[30,39],blue:[34,39],cyan:[36,39],green:[32,39],magenta:[35,39],red:[31,39],yellow:[33,39]},inspect.styles={special:"cyan",number:"yellow","boolean":"yellow",undefined:"grey","null":"bold",string:"green",date:"magenta",regexp:"red"},exports.isArray=isArray,exports.isBoolean=isBoolean,exports.isNull=isNull,exports.isNullOrUndefined=isNullOrUndefined,exports.isNumber=isNumber,exports.isString=isString,exports.isSymbol=isSymbol,exports.isUndefined=isUndefined,exports.isRegExp=isRegExp,exports.isObject=isObject,exports.isDate=isDate,exports.isError=isError,exports.isFunction=isFunction,exports.isPrimitive=isPrimitive,exports.isBuffer=require("./support/isBuffer");var months=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];exports.log=function(){console.log("%s - %s",timestamp(),exports.format.apply(exports,arguments))},exports.inherits=require("inherits"),exports._extend=function(origin,add){if(!add||!isObject(add))return origin;for(var keys=Object.keys(add),i=keys.length;i--;)origin[keys[i]]=add[keys[i]];return origin}}).call(this,require("_process"),"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./support/isBuffer":9,_process:8,inherits:7}],11:[function(require,module,exports){module.exports=function(){if("undefined"==typeof window)return null;var wrtc={RTCPeerConnection:window.mozRTCPeerConnection||window.RTCPeerConnection||window.webkitRTCPeerConnection,RTCSessionDescription:window.mozRTCSessionDescription||window.RTCSessionDescription||window.webkitRTCSessionDescription,RTCIceCandidate:window.mozRTCIceCandidate||window.RTCIceCandidate||window.webkitRTCIceCandidate};return wrtc.RTCPeerConnection?wrtc:null}},{}],12:[function(require,module,exports){var charenc={utf8:{stringToBytes:function(str){return charenc.bin.stringToBytes(unescape(encodeURIComponent(str)))},bytesToString:function(bytes){return decodeURIComponent(escape(charenc.bin.bytesToString(bytes)))}},bin:{stringToBytes:function(str){for(var bytes=[],i=0;i<str.length;i++)bytes.push(255&str.charCodeAt(i));return bytes},bytesToString:function(bytes){for(var str=[],i=0;i<bytes.length;i++)str.push(String.fromCharCode(bytes[i]));return str.join("")}}};module.exports=charenc},{}],13:[function(require,module,exports){!function(){var base64map="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",crypt={rotl:function(n,b){return n<<b|n>>>32-b},rotr:function(n,b){return n<<32-b|n>>>b},endian:function(n){if(n.constructor==Number)return 16711935&crypt.rotl(n,8)|4278255360&crypt.rotl(n,24);for(var i=0;i<n.length;i++)n[i]=crypt.endian(n[i]);return n},randomBytes:function(n){for(var bytes=[];n>0;n--)bytes.push(Math.floor(256*Math.random()));return bytes},bytesToWords:function(bytes){for(var words=[],i=0,b=0;i<bytes.length;i++,b+=8)words[b>>>5]|=bytes[i]<<24-b%32;return words},wordsToBytes:function(words){for(var bytes=[],b=0;b<32*words.length;b+=8)bytes.push(words[b>>>5]>>>24-b%32&255);return bytes},bytesToHex:function(bytes){for(var hex=[],i=0;i<bytes.length;i++)hex.push((bytes[i]>>>4).toString(16)),hex.push((15&bytes[i]).toString(16));return hex.join("")},hexToBytes:function(hex){for(var bytes=[],c=0;c<hex.length;c+=2)bytes.push(parseInt(hex.substr(c,2),16));return bytes},bytesToBase64:function(bytes){for(var base64=[],i=0;i<bytes.length;i+=3)for(var triplet=bytes[i]<<16|bytes[i+1]<<8|bytes[i+2],j=0;4>j;j++)8*i+6*j<=8*bytes.length?base64.push(base64map.charAt(triplet>>>6*(3-j)&63)):base64.push("=");return base64.join("")},base64ToBytes:function(base64){base64=base64.replace(/[^A-Z0-9+\/]/gi,"");for(var bytes=[],i=0,imod4=0;i<base64.length;imod4=++i%4)0!=imod4&&bytes.push((base64map.indexOf(base64.charAt(i-1))&Math.pow(2,-2*imod4+8)-1)<<2*imod4|base64map.indexOf(base64.charAt(i))>>>6-2*imod4);return bytes}};module.exports=crypt}()},{}],14:[function(require,module,exports){(function(Buffer){!function(){var crypt=require("crypt"),utf8=require("charenc").utf8,bin=require("charenc").bin,sha1=function(message){message.constructor==String?message=utf8.stringToBytes(message):"undefined"!=typeof Buffer&&"function"==typeof Buffer.isBuffer&&Buffer.isBuffer(message)?message=Array.prototype.slice.call(message,0):Array.isArray(message)||(message=message.toString());var m=crypt.bytesToWords(message),l=8*message.length,w=[],H0=1732584193,H1=-271733879,H2=-1732584194,H3=271733878,H4=-1009589776;m[l>>5]|=128<<24-l%32,m[(l+64>>>9<<4)+15]=l;for(var i=0;i<m.length;i+=16){for(var a=H0,b=H1,c=H2,d=H3,e=H4,j=0;80>j;j++){if(16>j)w[j]=m[i+j];else{var n=w[j-3]^w[j-8]^w[j-14]^w[j-16];w[j]=n<<1|n>>>31}var t=(H0<<5|H0>>>27)+H4+(w[j]>>>0)+(20>j?(H1&H2|~H1&H3)+1518500249:40>j?(H1^H2^H3)+1859775393:60>j?(H1&H2|H1&H3|H2&H3)-1894007588:(H1^H2^H3)-899497514);H4=H3,H3=H2,H2=H1<<30|H1>>>2,H1=H0,H0=t}H0+=a,H1+=b,H2+=c,H3+=d,H4+=e}return[H0,H1,H2,H3,H4]},api=function(message,options){var digestbytes=crypt.wordsToBytes(sha1(message));return options&&options.asBytes?digestbytes:options&&options.asString?bin.bytesToString(digestbytes):crypt.bytesToHex(digestbytes)};api._blocksize=16,api._digestsize=20,module.exports=api}()}).call(this,require("buffer").Buffer)},{buffer:2,charenc:12,crypt:13}],15:[function(require,module,exports){function Download(peerid,hash,contentHash,peernet,logger,callback){this.peerid=peerid,this.hash=hash,this.contentHash=contentHash,this.peernet=peernet,this.logger=logger,this.done=callback,this.chunks=[]}var Statistics=require("./statistics.js"),sha1=require("sha1");module.exports=Download,Download.prototype.start=function(){var self=this;if(this.peerid){Statistics.mark("fetch_start:"+self.hash);this.peernet.fetch(this.peerid,this.hash,function(arraybuffer){Statistics.mark("fetch_end:"+self.hash),Statistics.measureByType("fetch",self.hash,self.peerid),self.finish(arraybuffer)})}else Statistics.mark("cdn_fallback_start:"+this.hash),self._loadImageByCDN(self.hash)},Download.prototype.finish=function(arraybuffer){this.peernet.finishDownload(this.hash,arraybuffer,this.done)},Download.prototype._loadImageByCDN=function(hash){var self=this,element=document.querySelector('[data-webcdn-hash="'+hash+'"]'),url=element.dataset.webcdnFallback;if(url){var req=new XMLHttpRequest;req.open("GET",url,!0),req.responseType="arraybuffer",req.onerror=function(err){element.setAttribute("crossOrigin","anonymous"),element.src=url,self.logger.handleError(err)},req.onload=function(err){if(200==this.status){var arraybuffer=this.response;element.dataset.hasOwnProperty("webcdnContentHash")||(element.dataset.webcdnContentHash=self._createContentHash(arraybuffer)),Statistics.mark("cdn_fallback_end:"+self.hash);Statistics.measureByType("cdn_fallback",self.hash);self.peernet.finishDownload(self.hash,arraybuffer,self.done)}else self.logger.trace("XHR returned "+this.status)},req.send()}else self.logger.trace("No WebCDN fallback URL available")},Download.prototype._createContentHash=function(content){return sha1(new Uint8Array(content))}},{"./statistics.js":22,sha1:14}],16:[function(require,module,exports){module.exports=function(callback){function saveGeolocation(position){window.localStorage&&(window.localStorage.setItem("latitude",position.latitude),window.localStorage.setItem("longitude",position.longitude))}function getGeolocation(){if(window.localStorage&&window.localStorage.getItem("latitude")&&window.localStorage.getItem("longitude")){var position={latitude:window.localStorage.getItem("latitude"),longitude:window.localStorage.getItem("longitude")};return position}return!1}function geo_success(position){var latitude=position.coords.latitude,longitude=position.coords.longitude,position={latitude:latitude,longitude:longitude};saveGeolocation(position),callback(null,position)}function geo_error(err){callback(err,null)}var localGeolocation=getGeolocation();if(localGeolocation)callback(null,localGeolocation);else if(navigator.geolocation)navigator.geolocation.getCurrentPosition(geo_success,geo_error);else{var err=new Error("Sorry, no geo position available.");callback(err,null)}}},{}],17:[function(require,module,exports){function Logger(options){this.DEBUG=options.debug}module.exports=Logger,Logger.prototype.handleError=function(err){this.DEBUG&&console.log("error: "+err)},Logger.prototype.trace=function(message,data){this.DEBUG&&(data?console.log(message,data):console.log(message))}},{}],18:[function(require,module,exports){function Messenger(options){EventEmitter.call(this),this.socket=null,this.logger=options.logger}var EventEmitter=require("events").EventEmitter,inherits=require("util").inherits;module.exports=Messenger,inherits(Messenger,EventEmitter),Messenger.prototype.connect=function(coordinatorUrl,callback){var self=this;return self.socket?(self.logger.trace("Socket exist, init fail."),void callback()):(self.socket=new WebSocket(coordinatorUrl),self.socket.onclose=function(event){self.logger.trace("WebSocket.onclose",event)},self.socket.onerror=function(event){self.logger.trace("WebSocket.onerror",event)},self.socket.onmessage=function(event){var msg=JSON.parse(event.data);"relay"===msg.type&&msg.data&&self._handleRelayMessage(msg),"lookup-response"===msg.type&&msg.data&&self._handleLookupResponse(msg.data)},void(self.socket.onopen=function(event){callback()}))},Messenger.prototype.disconnect=function(){this.socket.close(),this.socket=null},Messenger.prototype.send=function(type,data,receiver){var msg={type:type,data:data};receiver&&(msg.to=receiver);var s_msg=JSON.stringify(msg);this.socket.send(s_msg)},Messenger.prototype._handleRelayMessage=function(data){this.emit("relay",data)},Messenger.prototype._handleLookupResponse=function(data){this.emit("lookup-response:"+data.hash,data)}},{events:6,util:10}],19:[function(require,module,exports){function Peer(options){EventEmitter.call(this),this.connection=null,this.dataChannel=null,this.callbacks={},this._id=options.id,this._wrtc=options.wrtc,this._iceUrls=options.iceUrls,this._originator=options.originator||!1,this._signalChannel=options.signalChannel,this._logger=options.logger,this._peernet=options.peernet,this.init()}var EventEmitter=require("events").EventEmitter,inherits=require("util").inherits,bufferConcat=require("array-buffer-concat"),Statistics=require("./statistics.js"),Utils=require("./utils.js");module.exports=Peer,inherits(Peer,EventEmitter),Peer.prototype.init=function(){this.connection=this._createPeerConnection(),this.dataChannel=this._createDataChannel(this.connection,this._id)},Peer.prototype.doOffer=function(){var self=this;self.connection.createOffer(function(sessionDescription){self._setLocalAndSendMessage.call(self,sessionDescription)},self._logger.handleError)},Peer.prototype.doAnswer=function(){var self=this;self.connection.createAnswer(function(sessionDescription){self._setLocalAndSendMessage.call(self,sessionDescription)},self._logger.handleError)},Peer.prototype.setIceCandidates=function(candidate){var iceCandidate=new this._wrtc.RTCIceCandidate({candidate:candidate});this.connection.addIceCandidate(iceCandidate)},Peer.prototype._createPeerConnection=function(){var self=this,pc=new this._wrtc.RTCPeerConnection({iceServers:this._iceUrls});return pc.onicecandidate=function(event){event.candidate&&self._originator===!0&&self._iceCallback.call(self,event)},pc.onnegotiationneeded=function(){self._originator===!0&&self.doOffer()},pc.ondatachannel=function(event){event.channel.onmessage=function(event){self._handleMessage.call(self,event)},Statistics.mark("pc_connect_end:"+self._id),Statistics.PC_CONNECT_DURATION=Statistics.measureByType("pc_connect",self._id)},pc},Peer.prototype._createDataChannel=function(pc,label){var self=this,dc=self.connection.createDataChannel(label);return dc.onmessage=function(event){self._handleMessage.call(self,event)},dc},Peer.prototype._handleMessage=function(event){var msg=Utils.unmarshal(event.data);"fetch"===msg.type&&msg.hash?this._sendImage(msg.hash):"\n"==msg.data?(this._updateUploadRatio(msg.hash,this._peernet.pending[msg.hash].byteLength),this.callbacks[msg.hash](this._peernet.pending[msg.hash])):"fetch-response"===msg.type&&(this._peernet.pending[msg.hash]?this._peernet.pending[msg.hash]=bufferConcat(this._peernet.pending[msg.hash],msg.data):this._peernet.pending[msg.hash]=msg.data)},Peer.prototype._setLocalAndSendMessage=function(sessionDescription){var self=this;self.connection.setLocalDescription(sessionDescription,function(){self._relay.call(self,sessionDescription)},self._logger.handleError)},Peer.prototype._iceCallback=function(event){var data={type:"candidate",label:event.candidate.sdpMLineIndex,id:event.candidate.sdpMid,candidate:event.candidate.candidate};this._relay.call(this,data)},Peer.prototype._sendImage=function(hash){var self=this,chunkSize=25600,dataSent=0;if(this._peernet.downloaded.hasOwnProperty(hash)){var data=this._peernet.downloaded[hash],downloadSize=data.byteLength,sendAllData=function(){for(;downloadSize>dataSent;){var slideEndIndex=dataSent+chunkSize;if(slideEndIndex>downloadSize&&(slideEndIndex=downloadSize),self.dataChannel.bufferedAmount>5*chunkSize)return self._logger.trace("bufferedAmount ist too high! Slow down..."),void setTimeout(sendAllData,250);var chunk=data.slice(dataSent,slideEndIndex),msg={type:"fetch-response",hash:hash,data:chunk};if(self.dataChannel.send(Utils.marshal(msg)),dataSent=slideEndIndex,dataSent+1>=downloadSize){self._logger.trace("All data chunks for "+hash+" have been sent to "+self._id);var msg={type:"fetch-response",hash:hash,data:"\n"};self.dataChannel.send(JSON.stringify(msg))}}};sendAllData()}},Peer.prototype._relay=function(data){console.log("send relay messge to "+this._id),this._signalChannel.send("relay",data,this._id)},Peer.prototype._updateUploadRatio=function(hash,bytes){this._signalChannel.send("upload_ratio",{from:window.webcdn_uuid,to:this._id,hash:hash,size:bytes})}},{"./statistics.js":22,"./utils.js":24,"array-buffer-concat":1,events:6,util:10}],20:[function(require,module,exports){function Peernet(options){if(!options||!options.signalChannel)throw new Error('Please specify a signalChannel {"signalChannel": signalChannel}');var self=this;EventEmitter.call(this),this.downloaded={},this.pending={},this._peers={},this._options=options,this._wrtc=options.wrtc===!1?void 0:getBrowserRTC()||options.wrtc,this._iceUrls=options.iceUrls||[{url:"stun:stun.l.google.com:19302"},{url:"stun:stun1.l.google.com:19302"},{url:"stun:stun2.l.google.com:19302"},{url:"stun:stun3.l.google.com:19302"},{url:"stun:stun4.l.google.com:19302"}],this._signalChannel=options.signalChannel,this._signalChannel.on("relay",function(data){self._handleRelayMessage.call(self,data)}),this._logger=options.logger}var EventEmitter=require("events").EventEmitter,inherits=require("util").inherits,Peer=require("./peer.js"),getBrowserRTC=require("get-browser-rtc"),Statistics=require("./statistics.js");module.exports=Peernet,inherits(Peernet,EventEmitter),Peernet.prototype.fetch=function(peerid,hash,callback){var data={type:"fetch",hash:hash};this._send(peerid,data,callback)},Peernet.prototype._send=function(peerid,data,callback){var peer=this._createConnection(peerid,!0);peer.callbacks[data.hash]=callback;var dataChannel=peer.dataChannel;return data=JSON.stringify(data),"undefined"==typeof dataChannel||null===dataChannel||"closing"===dataChannel.readyState||"closed"===dataChannel.readyState?void this._reset(peerid):void("open"===dataChannel.readyState?dataChannel.send(data):"connecting"===dataChannel.readyState&&(dataChannel.hasOwnProperty("queued")?dataChannel.queued.push(data):dataChannel.queued=[data],dataChannel.onopen=function(event){for(var i=0;i<dataChannel.queued.length;i++)dataChannel.send(dataChannel.queued[i])}))},Peernet.prototype._createConnection=function(peerid,originator){return this._peers[peerid]||(Statistics.mark("pc_connect_start:"+peerid),this._peers[peerid]=new Peer({id:peerid,originator:originator,signalChannel:this._signalChannel,peernet:this,logger:this._logger,iceUrls:this._iceUrls,wrtc:this._wrtc})),this._peers[peerid]},Peernet.prototype._reset=function(peerid){if(this._peers.hasOwnProperty(peerid)){var peer=this._peers[peerid];peer.connection.close(),delete this._peers[peerid]}},Peernet.prototype._handleRelayMessage=function(msg){var self=this,peer=this._createConnection(msg.from,!1);msg&&msg.data&&msg.data.sdp?(peer._otherSDP=msg.data,peer.connection.setRemoteDescription(new self._wrtc.RTCSessionDescription(msg.data),function(){"offer"===msg.data.type&&peer.doAnswer()})):msg&&msg.data&&msg.data.candidate&&peer.setIceCandidates(msg.data.candidate)},Peernet.prototype.finishDownload=function(hash,content,callback){this.downloaded[hash]=content,delete this.pending[hash],callback(this.downloaded[hash])}},{"./peer.js":19,"./statistics.js":22,events:6,"get-browser-rtc":11,util:10}],21:[function(require,module,exports){function Resource(hash,wsConnectDuration){if("undefined"==typeof hash)throw new Error("Hash ID as first parameter required!");if("undefined"==typeof wsConnectDuration)throw new Error("Websocket connect duration as second parameter required!");this.hash=hash,this.leecher=window.webcdn_uuid,this.ws_connect=wsConnectDuration}module.exports=Resource,Resource.prototype.setProperty=function(type,value){this[type]=value}},{}],22:[function(require,module,exports){function createWebsocket(){var ws=new WebSocket(url);return ws.onmessage=function(event){JSON.parse(event.data)},ws.onopen=function(event){},ws}var url="ws://webcdn-mediator.herokuapp.com?id="+window.webcdn_uuid,ws=createWebsocket(),Resource=require("./resource.js"),Statistics={};Statistics.WS_CONNECT_DURATION=!1,Statistics.PC_CONNECT_DURATION=!1,Statistics.resources={},Statistics.addHost=function(){var data={uuid:window.webcdn_uuid,active:!0};Statistics.sendMessage("host:add",data)},Statistics.sendTimingData=function(){if(window.performance&&window.performance.timing){var data=window.performance.timing.toJSON();data.page_load=data.loadEventEnd-data.navigationStart,Statistics.sendMessage("plain:timing",data)}},Statistics.removeHost=function(){var data={uuid:window.webcdn_uuid};Statistics.sendMessage("host:remove",data)},Statistics.sendMessage=function(type,data){function waitForConnection(callback,interval){if(1===ws.readyState)callback();else{setTimeout(function(){waitForConnection(callback,interval)},interval)}}var message={type:type,data:data};waitForConnection(function(){ws.send(JSON.stringify(message))},500)},Statistics.queryResourceTiming=function(name){if("performance"in window&&"getEntriesByType"in window.performance&&window.performance.getEntriesByType("resource")instanceof Array){var timings=window.performance.getEntriesByName(name);if(timings&&timings[0]){var data={name:timings[0].name,initiatorType:timings[0].initiatorType,entryType:timings[0].entryType,fetchStart:timings[0].fetchStart,responseStart:timings[0].responseStart,responseEnd:timings[0].responseEnd,duration:timings[0].duration,startTime:timings[0].startTime,uuid:window.webcdn_uuid};Statistics.sendMessage("resource_timing",data)}}else;},Statistics.mark=function(name){window.performance&&window.performance.mark&&window.performance.mark(name)},Statistics.measureByType=function(type,hash,peerid){console.log("measure "+type+" with hash "+hash);var name=duration=type+"_duration",start=type+"_start",end=type+"_end";hash&&(name+=":"+hash,start+=":"+hash,end+=":"+hash),window.performance.measure(name,start,end);var result=window.performance.getEntriesByName(name);if(result&&result[0]){if("ws_connect"!==type&&"pc_connect"!==type&&hash){var resource=Statistics.resources[hash]=this._createResource(hash);if("lookup"===type&&resource.setProperty("ws_connect",Statistics.WS_CONNECT_DURATION),"fetch"===type&&resource.setProperty("seeder",peerid),resource.setProperty(type,result[0].duration),"cdn_fallback"===type||"fetch"===type){var data=JSON.stringify(resource);Statistics.sendMessage(duration,data)}}return result[0].duration}return!1},Statistics.measure=function(){window.performance.getEntriesByType("mark").forEach(function(mark){var arr=mark.name.split(":"),type=arr[0],id=arr[1];"lookup_start"===type&&window.performance.measure("lookup_duration:"+id,"lookup_start:"+id,"lookup_end:"+id),"pc_connect_start"===type&&window.performance.measure("pc_connect_duration:"+id,"pc_connect_start:"+id,"pc_connect_end:"+id),"fetch_start"===type&&window.performance.measure("fetch_duration:"+id,"fetch_start:"+id,"fetch_end:"+id)});var measures=window.performance.getEntriesByType("measure");measures.forEach(function(measure){var arr=measure.name.split(":"),type=arr[0],hash=arr[1],data={uuid:window.webcdn_uuid,hash:hash,duration:measure.duration};Statistics.sendMessage(type,data)})},Statistics._createResource=function(hash){return Statistics.resources&&Statistics.resources[hash]?Statistics.resources[hash]:new Resource(hash,Statistics.WS_CONNECT_DURATION)},window.WebCDNStatistics=Statistics,module.exports=Statistics},{"./resource.js":21}],23:[function(require,module,exports){function Tracker(options){this._messenger=options.messenger}require("./statistics.js");module.exports=Tracker,Tracker.prototype.getInfo=function(hash,callback){this._messenger.send("lookup",hash),this._messenger.once("lookup-response:"+hash,function(data){callback(data)})}},{"./statistics.js":22}],24:[function(require,module,exports){var Utils={};Utils.marshalBuffer=function(buffer){for(var str="",bytes=new Uint8Array(buffer),len=bytes.byteLength,i=0;len>i;i++)str+=String.fromCharCode(bytes[i]);return str},Utils.unmarshalBuffer=function(str){for(var len=str.length,bytes=new Uint8Array(len),i=0;len>i;i++)bytes[i]=str.charCodeAt(i);return bytes.buffer},Utils.marshal=function(message){return message.data instanceof ArrayBuffer&&(message.data=this.marshalBuffer(message.data)),JSON.stringify(message)},Utils.unmarshal=function(data){var message=JSON.parse(data);return message.hasOwnProperty("data")&&"\n"!==message.data&&(message.data=this.unmarshalBuffer(message.data)),message},module.exports=Utils},{}],25:[function(require,module,exports){var UUID=function(){function b(a){return a?(a^16*Math.random()>>a/4).toString(16):([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,b)}return b}();module.exports=UUID},{}],26:[function(require,module,exports){"use strict";function WebCDN(config){config=config||{},this._bucketUrl=config.bucketUrl||!1,this._trackGeolocation=config.trackGeolocation||!1,this.DEBUG=config.debug||!1,this.INTEGRITY_IS_ACTIVE=config.integrity||!1,this.uuid=window.webcdn_uuid,this._items=[].slice.call(document.querySelectorAll("[data-webcdn-fallback]")),this._logger=new Logger({debug:this.DEBUG}),this._messenger=new Messenger({logger:this._logger}),this._tracker=new Tracker({messenger:this._messenger,logger:this._logger}),this._peernet=new Peernet({signalChannel:this._messenger,logger:this._logger})}function getQueryId(url){var regex=/\?id=(\d*)/,result=regex.exec(url);return result&&result[1]?result[1]:!1}function bucketizeResources(DOMelements,bucketUrl){DOMelements.forEach(function(element){"/"===element.dataset.webcdnFallback.charAt(0)&&(element.dataset.webcdnFallback=element.dataset.webcdnFallback.slice(1)),element.dataset.webcdnFallback=bucketUrl+element.dataset.webcdnFallback.replace(/.*:?\/\//g,"")})}window.webcdn_uuid=require("./lib/uuid.js")();var sha1=require("sha1"),EventEmitter=require("events").EventEmitter,inherits=require("util").inherits,Messenger=require("./lib/messenger.js"),Tracker=require("./lib/tracker.js"),Logger=require("./lib/logger.js"),Download=require("./lib/download.js"),Peernet=require("./lib/peernet.js"),Statistics=require("./lib/statistics.js"),getCurrentPosition=require("./lib/geo.js");window.WebCDN=WebCDN,inherits(WebCDN,EventEmitter),WebCDN.prototype.init=function(coordinatorUrl,callback){function connect(callback){Statistics.mark("ws_connect_start"),self._connect(coordinatorUrl,function(){Statistics.mark("ws_connect_end"),Statistics.WS_CONNECT_DURATION=Statistics.measureByType("ws_connect"),self._initLoad()})}var self=this,id=getQueryId(coordinatorUrl);callback=callback||function(){},id?this.uuid=id:coordinatorUrl+="?id="+this.uuid,this._trackGeolocation?(this.emit("geolocation:start"),getCurrentPosition(function(err,position){self.emit("geolocation:end"),!err&&position&&(coordinatorUrl+="&lat="+position.latitude+"&lon="+position.longitude),connect(callback)})):connect(callback),this._bucketUrl&&bucketizeResources(this._items,this._bucketUrl)},WebCDN.prototype.load=function(hash){var self=this;Statistics.mark("lookup_start:"+hash),this._tracker.getInfo(hash,function(data){Statistics.mark("lookup_end:"+hash),Statistics.measureByType("lookup",hash),console.log("lookup-response: ",data);var download=new Download(data.peerid,data.hash,data.contentHash,self._peernet,self._logger,function(data,err){self.createObjectURLFromArrayBuffer(hash,data)});download.start()})},WebCDN.prototype._connect=function(url,callback){this._messenger.connect(url,function(){callback()})},WebCDN.prototype._initLoad=function(){this._items.forEach(function(item){this._createHash(item),this.load(item.dataset.webcdnHash)},this)},WebCDN.prototype._createHash=function(item){!item.dataset.hasOwnProperty("webcdnHash")&&this.INTEGRITY_IS_ACTIVE?errors.push(new Error("Missing webcdn hash for item "+item.dataset.webcdnFallback)):item.dataset.hasOwnProperty("webcdnHash")&&this.INTEGRITY_IS_ACTIVE?item.dataset.webcdnContentHash=item.dataset.webcdnHash:item.dataset.webcdnHash=this._getItemHash(item)},WebCDN.prototype._getItemHash=function(item){var hash=sha1(item.dataset.webcdnFallback);return hash},WebCDN.prototype._initLookup=function(){this._items.forEach(function(item){item.dataset.hasOwnProperty("webcdnHash")&&this.load(item.dataset.webcdnHash)},this)},WebCDN.prototype._sendGeolocation=function(){var self=this;getCurrentPosition(function(err,position){!err&&position&&self._messenger.send("geolocation",position)})},WebCDN.prototype.createObjectURLFromArrayBuffer=function(hash,arraybuffer){var blob,element=document.querySelector('[data-webcdn-hash="'+hash+'"]');switch(element.onload=function(){window.URL.revokeObjectURL(element.src)},element.tagName){case"IMG":blob=new Blob([arraybuffer],{type:"application/octet-stream"}),element.src=window.URL.createObjectURL(blob);break;case"SCRIPT":blob=new Blob([arraybuffer],{type:"text/javascript"}),element.src=window.URL.createObjectURL(blob);break;case"LINK":blob=new Blob([arraybuffer],{type:"text/css"}),element.rel="stylesheet",element.href=window.URL.createObjectURL(blob);break;default:blob=new Blob([arraybuffers],{type:"application/octet-stream"}),element.src=window.URL.createObjectURL(blob)}this._update([{hash:hash,size:arraybuffer.byteLength,contentHash:element.dataset.webcdnContentHash}])},WebCDN.prototype._update=function(hashes){this._messenger.send("update",hashes)}},{"./lib/download.js":15,"./lib/geo.js":16,"./lib/logger.js":17,"./lib/messenger.js":18,"./lib/peernet.js":20,"./lib/statistics.js":22,"./lib/tracker.js":23,"./lib/uuid.js":25,events:6,sha1:14,util:10}]},{},[26]);